<!DOCTYPE html>
<html>
<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="UTF-8">
		<title>Simulador PlanMy</title>

		<style type="text/css" media="print">
				body {visibility: hidden; display: none;}
		</style>

<style>
    h2 {
        font-size: 1.8rem;
        margin-bottom: 0.7px;
    }
			#cuerpo {
	            line-height: 1.4;
				
				width: 60%;
				height: 100%;
				visibility: visible; 
				display: all;  
				margin: 0 auto;
		        font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
			}
			
			.aviso{
			    text-align: center;
	            font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
	            font-weight: normal;
	            font-size: 1.5rem;
				color: #616161;
			}

.horizontal-list {
display: flex;
list-style-type: none;
padding: 0;
width: 100%;
margin-bottom: -11px;

}

.link_precio:link, .link_precio:visited {
  background-color: #f2f2f2;
  color: black;
  text-decoration: none;
}

.link_precio:hover, .link_precio:active {
  background-color: gray;
  color: white;
}

.horizontal-list li {
flex-grow: 1;
}

.horizontal-list li button {
width: 100%;
background: #f2f2f2;
color: rgba(0, 0, 0, 0.6);
font-size: 1.3rem;
cursor: pointer;

padding: 7px 10px;
margin-right: -1px;
border: 1px solid rgba(0, 0, 0, 0.2);
box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);

}

.horizontal-list li:first-child button {
  border-top-left-radius: 5px;
  border-bottom-left-radius: 5px;
}

.horizontal-list li:last-child button {
  border-top-right-radius: 5px;
  border-bottom-right-radius: 5px;
}

.horizontal-list li button.selected {
background-color: #c1c1c1;
color: #000000;
box-shadow: none;

}

			.resultado{
			    text-align: center;
		        font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
		        font-weight: normal;
		        font-size: 1.7rem;
margin-top: 20px;
			}

	@media only screen and (max-width: 600px) {	
        h2 {
            font-size: 1.2rem;
            margin-bottom: 1px;
        }
		#cuerpo {width: 95%;height: 100%;visibility: visible; display: all;  margin: 0 auto;}
		.horizontal-list li 
button { font-size: 0.9rem;}
.resultado{font-size:1rem; text-align: left;}
.aviso{font-size: 0.8rem;}
}
</style>


		

<script>



	let datos_brutos;
	
	let datos;
	
	function borrapass(){
		localStorage.setItem('password', '');
		console.log('Contraseña borrada')
	}
	
	async function decrypt(texto) {

		// Este es el texto de apoyo del programa. Está encriptado por el tipo de datos que se usan

		let cipherHex = "cc3dc6d6ac70a0726b899d7a98fa314cb073a451f0f01cf40e4d25ccae760c93ff89771118399d820209fa590ab7cf94ba3f3addfb46309be5beb5bcc3e954e921b9ce12f8b2afbbb8e5b222910ad883ad46030703ea3bd69327bf3ee86b883ef9e4b606b80b1bf0f8960adfbf95a8ac3f4c3845dc86356f9073638bb6ec1f1f853b0503fd940463f25c1a1f34689e4de952e8bc5b29a4e3d4dc07665b400d63a9311e4b3b342f4e7b6a335d137fb7b92d066e6eecadbd1c300e7a902bfb066884b988f6dc24ff8517d4d32c825665806aae64ca737b72e6b3c7ebb1ee15b976bee0267b6439a1e2e789b5d402a641b31204690c6538911af7d68622df9b10f104c0333bd167625149b8ea0ae045e9929724e13bb6cc337790b37fff7a28525881fff1c15b1917ffa97ca32f94d161d0b8dc61f579d9c213e9441bd674b468f6c5915d1e370e9b894b0d624f0f285a507501dc58e8ffa6b2140aecda7dbd0e600d07713d93b4fc078206bb64aaa339cedef9191f34b39052023a9805d8c3a1afd332ed163d0520d2fd87796c36918d7249aa73827eaae7712d7288ae7acc55316e7c1db5ffd65d770a60d797dcaabc18da41ba0019786234aaf2e42e193580b0428f9d83cb9c28bdcba1bc83887394a6feeeb1248f2d0fbb2e49f0c1ff1b4c09a8bf23a552c344f61311c9be630c6c831a9801f9c38a7f840ef1d67d4aabdeff2b093624bf2bce902fdc65b30bef090ffd5b0af75c8ffd9c807934d845551b6810ab7bfa1898f49bfb5c975ffb103f18bc5e7fca6986192a37b50f0ebabbf43511790304228aa28a27225254a10ac1c6454dc194f2d29f6b2b50e7e64efa1b948effb602637b413191906954a9763647e1c75e4df7bad1a692caa55fe38ad4f6a268b416b5856ed717859629cb95ccfcd8e32205936291a343bebf1809835f4dfdfe2ae3c3efd664640694f788ac7a23d9e72235d24b5a4eefce6aea35fa7258db9612b009ef44984e036b641d0af7c8eb2912e75b3500f9a69f544475954edee28816da2569a4265d4414df368c5e74b32c120db3faaabb26231493ca19470272be10402bc9425e770f377ab7ce5cb1cd102e0753c9a15109c2eb975c15c4612b00d9722332c1debc28a7984eba358d1b4629c84cc699e50459321e67fd2147d7bc2898a4dc73ec963263ded9ca594c595e919e04a6ba72a8801d0578926da04417b11d9b59c63cf23e019fabed07945297a6fcaaf97e0b2d6dd2754d26ea4d8d8da67574ddb322993b47b655d2e0c63139723e2800d49bb18025d8b4e8a0671ef63fc316a3049cd0af280d1d8d1fa25f6320747fdf2557b2a38318e8b6ff87a7a1c538d2122b5db91cbb8a02736af25309c4f24884a333ec986c4fcc36d4513ee293f30ce0a1d62388e03788fdd9e912d5b6dd323dfac4089415a2d6dce28f21e147d192ab2d98d4b3b0b23b8ef72a68d7b83d4f09160c92e956502bb0b5589f36bc3a3ca6ef7c5de38f2395ab79e3d1d2f253c8f8bf6c346a6671e9f247902a4d437f503a5ab901795cdc692df972acd63ca728111e5d2e06936658fc9226809a3ad9cad34c29103aaf229b880ad69040f1c0024074b6c082a1742c29f862d7b5e3a9673647c4cf6b65b1c1416494b6fe179987b74da6593111b8e227453431cd1c5cf832696e24d29da5e99ea76f85a97ebe73ffd42fe1086731f8b35f34f16a148b81d0a250eed0557563bf1d4ddc5f9f42809c39f9a7646562850c41c73b09c6e86ec5d3424fe9f71e3d65ce6675c82be7be888119d762504fa7624b1786c63b64e4e07da9094acdf4acea6e61fafd92425b893b426dfef4aa78fa73fe1ba6f8b32e8fb059d12f6377b3a3612be4f08233cdb20111f2edfe78a71231323835d714cb12d45240f3cab68568afe1dc784d03613de14aae26ce16b1d114da47eacf6bbfce709177afdc40e19e098178ed61acdb52aacb1369fa7e418503bcaaf693d42af2437377d135985b0f6884847d006930061739a919e71ddfa7211da01f569a6810793e58eabd808aaaeed39537e73c55338ad26085d8ecff5c3f7419ce12fc90a6dade99afd27f6007f574515ebbf9608b13951aeb9f4a08d9ac09e8248c204b23b5dd6ef410871aa599fec336223d1a147b570273f281ccd797eb193bd827dda39911aa4acf808f3592b513965ecf228ffd4f2ce88674c35a197b14094d9e470eaf9f2fa9218d267b8078740977586e84a3076c0f9242f2a8fabad159ef48e3c7ea1b4cfeea1d511e3259f4760ca8db7e1ed9f64a5fc17e383a8b52d94ede093f7319be1e0a7d5abc90145fac461c78f190d57acf0c13bb3bd9e2ea5efa2833002574d96409c68631c1623f445eef49701fd3c18a97dfdebc853a3229feaed8e20867bfe1c9896a7db9e1efe392f6c92aea9c6a9a0bd5ded2dcdf9b95bf562b072323bc4a5407ce0f69b1f3471b5c1c88d63bc634e0bab2b4beeb8a859b5bd048a001157e1bb527eebd271587c13929822f8f84f6ef7728da21b74463fcb3499a8d6f18f56b8c4f41d76880a96a4d5413a6a6fee4b4b2941bee877b936e21112dbaf2073be9c2564581ba5f4bbdaff99f4c3c73cb9559ff3bb90991d06008269d00a983b526b494898afa333d6b8ab664730b33ff66ee600d2773ca9f2a8c65a5cd197017a1d44bd303ce45c44c8f5e881146ff51856c8d7f589f0d0e9ca8395b791222a5cc178c6a76663bdbb550372c8db4ef32b11b57233ee860fa59c6a89bed80723ffc8c366d68bff23941fcfd9b2c6f2f1437a0b035104d43e3fc0585ebf5ebcfd12269949b02ac";
		cipherHex += "da6ee00987b98eef1ac660e91049d9132d31a24672e424f48bff09f4b5850f1ad83d31440c59b2d3903f68c3da8d7c3c704108e1b132bc6e32dda97f89519aa679b86021dd734c329c67465c78d24592d1ab3bfb7b295c59fb6f1d550ae9663f158cdac626f79ca7073c0c02fe4d6df4aba11792dccfd71fb73769044846ebd30bf80c720443199df3ba0de10f437a23a845dcd65f9f9a199ca4dbfe60eb09028420eb8392ec0f72383b4cd4fa1c02ca840cd7c4aa578199f7fc553c1ab19322bd11cafac202f5329e4b247c47855166cce1a21425909bb95a8491c8fbe1f3b237b7fd05ca8b14791d3181b15c9c5e535f5f1bf321340f4e5e250c81bf449201f74cc71ece7e61d39342a3c27c1e37a191886ea928e91dfb34a0e233bd3e907c12a9ba048369de04570f04a0cc7bec5b182e7b18ce7a23de5e33d703ea978228e930f7dacdd6f8411d626f13c079ee26fb0a784be325c248d8786ee80921eeb0720996ea0099bcbb2f1c98f55171ad14f967a438c48e10b6c230736da6486c74eca031c52a2421d8c6ddd0c332c3204abfb7522cf0503f2125f9693d06caf857403f39a94f899e1cb73497e1ea374532e1152235721369522c17b303e835c0039ec7e1794d454e2dc3c863c41c9e10171bf773eac20b49f54c5d9fee516f94ef6fab20d9db58332b787c3cd9c928a234c0fe78016e019c132e9e6145177bf6fa53b1e16c634f7307425f79fab8d0aa64229eea7d89bd999efae30e3feec81f9e42278d57194b4658fd1611f44acc835e7c52733fc43ed3d29b33816517fdb4b1b064eb28421c9afe3b95a85230afdb3c5d6373305c1774bee9b537d8bb62c00b9079ed23aee2f76cebe8d3118d913b012228460fc7fc0955cfe5007934ba3349e8b4a4198dbcd352db4944b63b69680b6d805486121f7d9a1862d67c0af00cab35d1478cf0c933f3cb5492d01401a98114c4ce138ad5a170724f932d33f7d4c29c10766c897cf4554ee9ae257d74656fdcdcf8abfe106b8e67aa52b9ca892822a470fdc9cf3fed973989140d547213ef1e6ed1bdbaeebc6fb6058e941e6b7bd5a2b5ca5fa5e06b2b6075de4ca8393683097c7e1f2ca98121fa072972c40b4a63ed4c80c56e568d16943875d05ea1c85b4b2e6154d1b3c97d644d575fbbcb5aca2765d42bfd68c6be8aed0dc08c61d8be6149cc1f32bff535ca8b6c3780ad6009627595d8d228d35bd007abe6c2393a1c516ec7e2bf5146365858fe4682fe9f6f9b1842768f71491e0447693dfd94b3be9c3987017999c662ebad9acda86177046521209d655df6053277dc0d12a970424c9f8059c88e8c2c82cbf5589be4ba2110c3dc07e99ae8ea613c0e9f9c29f071dbd7d5dad46661819c2627c99f06e5305b663b7020a5ffb760568682cf49ebf0e4fdb0b9c6e2c4170df45e124a0e28110841456aa1a39c4c40365f6258ef25025ebc0cdeb71b787add33ae0a97ff49b3b48d0fe7fbed6ed840839d4b95c2c8bebccd1d23b7d8288d69a091af1fd5e0b9f4e758a10f6f3c159006b0c3d29bb8dae1ecc980866539e7b47edb4587f2a5d3b90c7d9bf3fc0aea45948c2a055d504827d7f46afb5739dd577b7f96e070119da2e1ad9bb037afff624024debb91489960acda05f9bb214331393b7a17a267897f09ac725aa46cf9b36263d528873c8f35d64444cad813f187e76cb11c7ad448a8d49092a0ca781a1686d895e4bba10db28c3eb33eaaa3ce9944bc9f45792c5f71936d2cbbb1a97f60bf09ee99bdd5cfab2c2cdd9350222a959d24115b3860f3c6f7445a655e47b8be5d26e9e93c5a54bcf33e0eef1165d85868c9f8648da62bb4c65680ee9e663d2de7e032bd6a4a0100443a4de231ccabb4dddd365c2ceb064a4c41d45e85c66d56deacf68cf248243e6e28598511797a8ea0b0fd382c13a075eeb1d7d5f989f98804c6514d5df731c28601fbc18a989716b1376e2c586e738a7c45deaeffa4155cc0fd428aff83dbbc5545ed1ecb531a39bdfdf9b41cad4bcd2e964925a198b2fcfa050d1209c43d0e06173f431601f121d8649f23f90ce64076d16d379c7a23c06ab624277c1281d15047b239455eb45fe94622a61ddfb82966ca02097e6ca8984b85fc3af6eb44982cfbb800a84b692c7568a2b3d327a8ebd0ac1e7390891c04da5120a3a6407dd7a4a642e8ada1f0953785c900fd5fccca3444b7da8eccd0930443e256e336b79b0034b28e2ecbdd124857a978169e4321d8d5101dacecf14121a04d1dbe10f64382ca8c87105d3229b7be74796b5fb4a6b5e0b9f2073653976e0bd11b46f0e3de8f7c4bc53e1ae19f163a9c865df62addf712bd17c5677509842b572859dbae6dfe4f19699d21ac24343a6582c8f3603a6f9e7b6aac20b20155769b8154dea6849ceeca68837e98d4ceb483bb3df2473d72e6f01ff949d0d299288cea238831e7c07928cb667b1a9ee636bedbfe97d510444cd7f5c1ffb594032976f2991f063d59114c81eb59c6953e3201d3f14afb352a697a168c3fcb9aa04077cf8e5811f831caa88b57132c7bf529217334b8d88715ce288382c174ddeb26e3cbe4a91e"

				// Funciones de apoyo
		function hexStringToBytes(input) {
			for (var bytes = [], c = 0; c < input.length; c += 2) {
				bytes.push(parseInt(input.substr(c, 2), 16));
			}
			return Uint8Array.from(bytes);
		}

		function removePadding(input) {
			padAmount = input[input.length-1]
			unpaddedSize = input.length - padAmount
			return input.slice(0, unpaddedSize)
		}	  

		// Código de desencriptación. ivHex y saltHex no cambian entre webs. Siempre uso la misma.
		const saltHex    = "55de388d8fd8e67b6da0e68d4022e444"
		const ivHex      = "05998ad87dde9461c89b50cc97ebbb8e"
		let salt = hexStringToBytes(saltHex)
		let iv = hexStringToBytes(ivHex)
		let password = new TextEncoder().encode(texto)
		let passwordKey = await window.crypto.subtle.importKey("raw", password,{name: "PBKDF2"},false,["deriveKey"])
		let key = await window.crypto.subtle.deriveKey({name: "PBKDF2",salt: salt,iterations: 1000000,hash: "SHA-1",},passwordKey, {name: "AES-GCM",length: 32 * 8, },false, ["decrypt"])
		let cipher = hexStringToBytes(cipherHex)
		let decryptedBuffer = await window.crypto.subtle.decrypt({name: "AES-GCM", iv: iv, },key,cipher)
		decrypted = removePadding(new Uint8Array(decryptedBuffer))
		plainText = new TextDecoder().decode(decrypted)

		
		datos_brutos = plainText;
		
	}


 function recopilaSeleccionados(){
		resultado = '';
		espacio ='';
		var elem =document.getElementsByClassName("selected");
		for (const element of elem) {

			if (resultado.length!=0) espacio =' ';
			resultado = resultado +espacio+ element.textContent;
			};
	return resultado;
}


function estaPalabra(frase, palabra){


let patron = `\\b${palabra}\\b`;
let regExp = new RegExp(patron, 'g');
let esta = regExp.test(frase)
let result = esta ? true : false;
return result
}

			function CambiarPrecio(precio) {	
				let nuevo_precio = parseInt(prompt("Introduce el precio", precio));
				if (nuevo_precio != null && !isNaN(nuevo_precio)) {
					dibujaCuota(recopilaSeleccionados(), nuevo_precio, VR);

				}
			}
	
	function devuelveValores(indices) {
	    const indiceArray = indices.split(' ');
	  let resultado = datos;

	    for (let i = 0; i < indiceArray.length; i++) {
			resultado = resultado[indiceArray[i]];
	    }
	    return resultado;

	}

function showSelectedItem(item) {
const container = document.getElementById('list-container');
		

	x = parseInt(item.parentElement.parentElement.id)+1;
	const nombres = devuelveValores(recopilaSeleccionados());
	const nombres_valores = Object.keys(nombres);
	if (nombres_valores.includes('PVP')) {
		precio = nombres['PVP'];
		VR = nombres['VR'];
 		dibujaCuota(recopilaSeleccionados(), precio, VR);
	}
	else
	{
						let txt_resultado = document.getElementById("resultado");
				txt_resultado.innerHTML = '';
container.appendChild(generateHorizontalList(nombres_valores,x));
		
	}
}

function generateHorizontalList(items,nivel) {
const list = document.createElement('ul');
list.classList.add('horizontal-list');
list.id = nivel;
items.forEach(item => {
const listItem = document.createElement('li');
const button = document.createElement('button');
button.textContent = item;
button.addEventListener('click', function() {
const selectedButton = list.querySelector('button.selected');
const nivel_actual = parseInt(this.parentElement.parentElement.id);


	for (var i = nivel_actual+1; i <10 ; i++) {
		var elem = document.getElementById(i);
		if (elem) elem.parentNode.removeChild(elem);
 }

		
		
if (selectedButton) {
selectedButton.classList.remove('selected');
}
this.classList.add('selected');
showSelectedItem(this,nivel_actual);

});
listItem.appendChild(button);
list.appendChild(listItem);
});

return list;
}

document.addEventListener('DOMContentLoaded', function() {
	
const container = document.getElementById('list-container');
const cuerpo = document.getElementById('cuerpo');
const sinpass = document.getElementById('sinpass');


cuerpo.style.display="none";
sinpass.style.display="none";
		

	//const nombres = Object.keys(datos);
	const nombres = ['PlanMy Mac','PlanMy iPhone'];
	
container.appendChild(generateHorizontalList(nombres,0));
	
});

			function dibujaCuota(modelo,precio, fv) {		
				
				
		  		if (modelo.includes('iPhone')) {
				      rate = 6.95/100/12; 
				      nper = 24;
				}
				else
				{
				rate = 7.45/100/12;
				nper = 36;
				}

				pv = -precio-18;
				pvif = Math.pow(1 + rate, nper);
				pmt = - rate * (pv * pvif + fv) / (pvif - 1);
				intereses = ((pmt*nper)+fv)-precio;
				codigo_enlace = '<a class="link_precio" title="Pulsa para modificar el precio" href="#" onclick="CambiarPrecio(' + precio+');return false;">';	  
				texto_resultado = 'Importe: '+codigo_enlace+'<b>'+precio+" €</b></a><br/>";
				texto_resultado += nper +' cuotas de <b>'+redondea(pmt)+ '€</b><br>';
				texto_resultado += 'Y una última cuota de <b>'+redondea(fv)+' €</b><br>';
				texto_resultado += 'Pagando <b>'+redondea(intereses)+ ' €</b> de intereses<br>(incluidos en la cuota)';
				let txt_resultado = document.getElementById("resultado");
				txt_resultado.innerHTML = texto_resultado;
			}
	 
			function redondea(valor){
				if (Number.EPSILON === undefined) {
					Number.EPSILON = Math.pow(2, -52); //Hay que meter esto para que funcione en IE11
				}
				return (Math.round((valor + Number.EPSILON) * 100) / 100);
			}

			if (localStorage.getItem('password')) {
				pass = localStorage.getItem('password');
			} else {
				pass = prompt("Contenido protegido. Introduce la contraseña: ");
			}
			decrypt(pass).then(function() {	 
				datos = JSON.parse(datos_brutos);
				localStorage.setItem('password', pass);
				// Hace visible el cuerpo de la web, para que se pueda usar el programa. Los datos desencriptados se guardan en la variable "datos"
				document.getElementById("cuerpo").style.display="block";
				document.getElementById('cargando').style.display="none";
				
		   	 }).catch(function (error) {
				localStorage.removeItem('password');
    				console.log("No se han podido cargar los datos. Se borra la contraseña guardada.");
					document.getElementById("sinpass").style.display="block";
					document.getElementById('cargando').style.display="none";
					
 			});
			


</script>
</head>
	<body translate="no">
		<div class='aviso' id='cargando'>Cargando...</div>
		<div class='aviso' id='sinpass'>No se han podido cargar los datos.<br><a href="#" onclick="location.reload()">Actualiza esta página</a> e introduce la contraseña correcta.</div>

		<div class="cuerpo" id="cuerpo">
			<h2>Simulador PlanMy</h2>
<div id="list-container"></div>
			<br>
			
			<div class='aviso'>	Los valores son aproximados. <br>Por favor, no imprimáis esta hoja.</div>
			
			<div id ='resultado' class="resultado">
			</div>
</div>
</body>
</html>
