<!DOCTYPE html>
<html>
<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="UTF-8">
		<title>Simulador PlanMy</title>

		<style type="text/css" media="print">
				body {visibility: hidden; display: none;}
		</style>

<style>
    h2 {
        font-size: 1.8rem;
        margin-bottom: 0.7px;
    }
			#cuerpo {
	            line-height: 1.4;
				
				width: 60%;
				height: 100%;
				visibility: visible; 
				display: all;  
				margin: 0 auto;
		        font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
			}
			
			.aviso{
			    text-align: center;
	            font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
	            font-weight: normal;
	            font-size: 1.5rem;
				color: #616161;
			}
			.aviso_mini{
			    text-align: center;
	            font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
	            font-weight: normal;
	            font-size: 0.8rem;
				color: #919191;
			}

.horizontal-list {
display: flex;
list-style-type: none;
padding: 0;
width: 100%;
margin-bottom: -11px;

}

.link_precio:link, .link_precio:visited {
  background-color: #f2f2f2;
  color: black;
  text-decoration: none;
}

.link_precio:hover, .link_precio:active {
  background-color: gray;
  color: white;
}

.horizontal-list li {
flex-grow: 1;
}

.horizontal-list li button {
width: 100%;
background: #f2f2f2;
color: rgba(0, 0, 0, 0.6);
font-size: 1.3rem;
cursor: pointer;

padding: 7px 10px;
margin-right: -1px;
border: 1px solid rgba(0, 0, 0, 0.2);
box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);

}

.horizontal-list li:first-child button {
  border-top-left-radius: 5px;
  border-bottom-left-radius: 5px;
}

.horizontal-list li:last-child button {
  border-top-right-radius: 5px;
  border-bottom-right-radius: 5px;
}

.horizontal-list li button.selected {
background-color: #c1c1c1;
color: #000000;
box-shadow: none;

}

			.resultado{
			    text-align: center;
		        font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
		        font-weight: normal;
		        font-size: 1.7rem;
margin-top: 20px;
			}

	@media only screen and (max-width: 600px) {	
        h2 {
            font-size: 1.2rem;
            margin-bottom: 1px;
        }
		#cuerpo {width: 95%;height: 100%;visibility: visible; display: all;  margin: 0 auto;}
		.horizontal-list li 
button { font-size: 0.9rem;}
.resultado{font-size:1rem; text-align: left;}
.aviso{font-size: 0.8rem;}
}
</style>


		

<script>



	let datos_brutos;
	
	let datos;
	
	function borrapass(){
		localStorage.setItem('password', '');
		console.log('Contraseña borrada')
	}
	
	async function decrypt(texto) {

		// Este es el texto de apoyo del programa. Está encriptado por el tipo de datos que se usan
		let cipherHex = "cc3dc6d6ac70a0726b899d7a98fa314cb073807df2f151a11e4d5286ae0d1ec3eaf45c660632908a4c1d955193151af0df2b478eec4a729597beb7bcc3eb54e437a6c15af8b2c1aeca8aae288c16dd86f2505a68615eeb719c27ba40b36590138996da65ad0004f0f5d308c5b2fedaaf42562d44dd8c396dda2c4ef1c4ff100f8f721e62ed20d6c4fa5d1d617878954bb67f92ce1043f4b2cfde527c57184717c168063b676e6d58706c3d4d6b7b125b8a09247efb99cf04711b13ff57fb6a0b9eb181ebd63fe3903caad3208224348c64e63be75807728cf491f0a7b761da67a6e36477193a3e1f4e99d78b23ad41b312040b6f035dc909fb9c9c5cb1fe1ee964a0282dc701015d40bea715ec31ec0d3b83e23ec3e9736fd1ea0df97c5a4a5682fee9db237300e9bc1adf349f982995bacd19e176d7da59ff2544c13adb60afddd84a7802039b894b0d07286d4d02437e4cc7249cf9d6aa1c0fe4d07fad6a4f031f7230edf8e9088408c903aee321cd93e2656b32c3885a0a3d9107cba28ef0c527884c755b3095fb89690972b90dd0f69c30aa0ac0be692510d3a062e12543021d09bfe2d05e32087ad48fb99ecc009b5ad86f676e6f7ee1b6e42e025480b0089fe4c288c034ac94b7e5ecd42ccfc3a6b7a91cc81135c93608e0c3f8142749dcd77abd37a527fa191684a678111ab76a8040eaa4ef01950dbec86a45b3bbcb5b117733d94db0822d992ca6059d2d32fd5b40e15990fce89f262281306c2b5110ab32ed1e94eefecf2c8f1eef735866a75c3ad2729b6f1e47ad4e1ddedd8a2418371f122d92c7be573a1341c469bfdd4a068881fcbda8412b50adf448804b81c9f9e97e177b1164879a264fb465422fb8df3814a1e0dda4d195e910a684ccbcb61ad83db5f26dc519c7985befa8ccfc92f6241a921c8ead5bf7a87e7de906559f9148f8d5fcb1017f108193eca0726fccf13d5988144c17f8af0e982dbb633abafe1eb20df754f73003070e0e02ebc2e97a5db6554743c2263deb7236bd3ab4bb9016b77572b27f294660b52787526bbc214303c79adce335295c87b47e255d35f108505fd642325e0f5d3ce8dd48fed65c6bc9f10faa48068cb4830dc676dc3c0b90171146ab87a449c3fc55ac24eb7d5d3fd82aa295eb06112b126cfd6a49cff43c2a72093fa3c46d3188860a8f9b4e5591eb51aab93af7fc69606b9a7caf0f0ccd699d29de37fc3b08cef49777fb09ddb2ffffe97942e3cf664f5a67bc53c0ae12a5d3d6d571893810b653d692de383871292851daefd1f67dcbbea5b719709160d506a400477c08102a5cdb4efe18af95c433f63a59aae9936a849dffeafaff9523c44b5f3ea91ea88248651492305683be01cde733ec835f0ed43e9c4a5dbe80b60ce8efc24c80b92fa389bbfe1ea3e1c8316afac20ce60daad7ddf49820a947d1f1c83d80dffcaacc58eca83c7bdabb3624496264cbf1353649bcbc50d622b0335de8ef1074e3e544fcbf6de1d69db653c8e3dfac8edc0e37a8e94b96245a4019757a42f8580b5ada1b35f17babd928ab467610454c6286725db3db2493ed22c8dbdd5401467ef973d6904b8fe25b9300b8f417ee8ddce2c0fe8ef30482a5f7e7731b3db6df6467abcf0268fcd58217f5e4a240ae452376c4f82e0a2127ae1e8b059b063a6d023f1aa78dc57eb7a97ef7619dbb53e1640727f0b84239ea7501a0ffd0a931bcc3413672923660d247c43ad3cb37e18a140a6993070dcb32d23b412282e44c08bcff1e5748bc767acd5cb7a89ed86dd5163a59a46a52178c97644fcbee65ab0f078be0a5ec6014a6aac92703d0230f7be9c0d860bb639e7ccff6ab4deaab4fc748067bb8af2978ffaf99f37f025923f3a3a16cf6605d19383dd515b55cd43e69f3a0d1e772bbe7df3009036128d604f837c65fbdd611e058b5d932d0ad04fb2eb7d395583745a249a33ef29a48be870726e36a34d217c1b3f6f9f958802f1263da3583407518f0ec6c096c2802447cb746ab50400b863eb41f18c57c41166d4da1ad8fc7cfc1c08d76be4e3b4c9add67fa8ef7e9054b766da403fe94bdd3c0c6d5a2686b04822e5d5df3a61cff7b9815e89d3a53d7b4249856e0445b20a3d062a54fac35ab81a6a7616826141224425456e2998d8ee2ba5060cf2be1e38d1f960abdeca435f8d4728d48d946e4f14231fee808d4555366180150d65a1edac83bd4388d4c56f20a1860615b7494cc7b7919812d96a4f0bc9c10ed5a968875b7ebedfd1e1f51251ab76219e6c87a6dfcb6521e980c3e3cf94ad24ed1093d6663ce6a626c52b1870b59e3464d76e1f69748c94746e223f296f74d229f8f746a3bd77c24b69739df643c5828b5163719ddb3edf7898cac8e792952b59ee3e20828a8e5d3fc3f22feb6effef5446b958ac727c65ddbc6ffaccb9583bb2c71176474bc283761ab577fb8be5c67281af8ce36c83dfca3a8af95c4849de75b0ae61d74097b15ad1fa9e2794fde91794cda7697c9e0f8435ac260a7200795bd51fbe8740cf7779f372bc32fccb7702e5ec95b0f89baf5f6b25bf6c622870a58705be2e90a79e5a52c37f5d24949b8a0e493235d2c8cd945ed5ae55e859766576a8000de99f413b29d8b8afa333d1bd1fc012b522bb5779c0c262704ca8d24ce69aace091373a1d401c660b6209b5a9c5e8c1e2dbf25ed35951d3efe010094e4734e75683ca5a03e8c68686d3ac3ae533122ffd78e22cc4847207ce612fa5bc6a899eb806521fcdd381902b2fd3a40e8e9d33f42556624cee3211e0f4d91fc0785ebf0e2c5c6346ac5c429d2";
		cipherHex += "da65e61a85ec959455c878a06613d41b6325d02a59e44e90efef0aebb7901460a8495952065ba5d3c376719cb5ca287f301c5bb1a973e51c55bfb302da4b92e477ca6023dd7349359b705c5c298d6ebddfb359b922255314a4720c4505a4031005949b9f5499e3b7083b1d0fbc410a8ed9d57f81d0ccdc0bbb510e5b5e50eed3178b137c1c0014f894d80de14557184cd650cac531f9810f8cc4b0f269e8411688258c9ccdab587259593eccbb0c7ec95fa265b8fa6ef181b6ed51381bb0f53db309838cf0769f6b8629441f51934106acfab6173a87e3d84fc389d9fef9eab17bf8a2139398770d776899d404c9035d47726be0293f7d1e522844de923ee06eff9f73afa72239dd8b6fd3d1700331a98d9c66af269b799e20ddb225b37c9e0e12abba04846cde13480155aeb818f84e1b4c2814c5307ca22a56c40b9ec5942bbe30f1debfcef545107e6f088a28e052e41aa0f8565a8d04c93f39e80b47a3a31c1096802debced74d0d90ff4872b81a8d63d420cd8f17a1dc32733cf9561a27f8b8709c583f40187c6aa59073cf2d1dbfd23221fb306b3431b579102db6f82e166564e50fcaba6caf7580e9e0213368be5275356f74dbf09376f758f3218c0d8da79c6a23155b2596dc0bef609e18101a8428e4da263987203988e04e6b9bab6dbe3dcda23f2023687f73d5a8498f3ad8f97c02104f9c7f079e0b27766fe2fb55fea56e762e63b390f813bbe4c7be2b39d2f0708dd8c99efae30e3feec81f9e43228b5a1b5e3c28897e04fb4bd38d45324f2c22d023b6e4db2bc03c65fbb2c3a86de828410b81f04f91d84a32aad02b4a623b300d4844a02974dbe7f8209913a83eb27df4bfc27cebe8d311ebf32c413a260c14ae867b21a7fe0c712ab92e458ed1fb5ec1f79e01c55369f678351044c862f3d5395542a22d62d63619af65ed6d930038226e38f6d05dc7c16e13a6c057ff854f98d5aa39683ec5486baecce9e81002069a76f35a5be5cf5b7d18057ed5c3fea5ad0e7bc17ebe27eedef43122ce5d8fbba35efe9e39930f75317c0b8b7a7fc5b9bba3be7fbb49c1ae506b0cc7ee8cbe35fcf80d713f25d0548549228d7d2c6f0b60bfac0a860743369f105e2fe35fe4af0b0e9e1cd83416bf73afd0584d291f1ad1dfe07d0e283748afc15c8e2570ca3c9d7d86a681a21fbeee0487f97c5fbb4372f1d60b89c37d3ecea1650c583b95d79838c46fa21feafca6564409477da680a44755543a54f040c6e79369995329369c1f501e6e6a1b4f91f5a1b0942e861477edc212f3a699cbb37a3c4d65217193177ff586dcbfe88eea0e236906c1dc04add6d53490b9cd61a5a36290a1c4d109f1b798982960df26375da274d5cf9ccdd37561819c2627c99f06e5305b6b317020a5ffb760568685cc49e8f0e4fdb0b9c6e2c4170df45e124a0e281108414867a1a39c4c40365f645dee250a5fbc0cdeb47a2c1f856ab621e3ff3dd9a4860fede4f614a834eb8b4897decba5f7874c2dc5856fc60cf8c8b755c588a8c6e758eb1f0f5369906ad3d0dd93adc1998fd3c7c97f2399f46cd55dcee5a2c0b90c7d9bf3fc0aea45948c2f035d504827d7f46afb5637dd527a7f96e070119da2e1ad9bb037afff624024deba9d489960acda05f9ba204e3139397a46fd799e201ea63f0ebaac29600372cd23ce2df876867f7784c01bba91f86fbd2634d443e1ce87a6d2d2390176e9a49588d8b207ba952ccb5ebde4d38344a79f3466734928e1510f98b1a93572b801f0fc89a5d7ea3f4bbbed4220668a8c280c4b2950f3c6be543a1d3852ffa34d21e5f3596e24a4b22e6e816f769f1474d38c21c1995bac874586e588126a72f1b921df045d41184671569e45cadbacded93c43208a66155a52d35c9db9390999fbf692cb6a6b653b385ad2111a199edde3ea317904c55e92b1d8d5f9fda2861ceb213f319523cc9901fa858a98f371a54a3d37533b64ed5768d0b696ee4352d8d03299f78aaaec5947a441b7277b29bf8baaa31ffa4bcb2ae4512ea09ca5e5ef2e731201c03f784a063645492c8b53930ec67ea05028e2a5b27a2f943030be2ca4ea85cc6ed2ee105ff360565a802df10731c37bb6b63101a1160a607ac7e45d8db523e0f427c973ede117c92f7e6c6d63eea2ba5dda9fb8bf137091921066bc0e67bcbd262180715beb87feece4e82e85c249e748f8b82c05a4beeea5de8b6323f555fc27d8e7123cfdc33ac7bc1d0b57a13602e87561c094496faaea83592aa24210ab1e8247f2d2848115452523fcef7a6e6f5cc183f5f8f8ab753055e57600d61e46e5edaa8b0c53cd3b19f6881276cd884e907dc98a0bbd7de8150765e5315e2046cdc113fe23787b943ca42267752ed3c6b8016038b77caa16dea163211cc2992b83e5d0d1a0be00da669cd8b8f890b63bad3b4972a8bf54eb4a87d2fa4b9c97779c25a59f055caa76796cc8fc35e9dbf893a7084d40d1e2dbe89eea032174f4f044592b000129e1fc19de9e772368a9833e932e27626e01f455948cba416bceb4474ebf37e6f6d3093f1844ca17165118e0841bb34b06eeed25813f63e274152629ae4e085750524b977c96eb22a34607ee7cd451398990e142f4526d15e8339a7e91398b8088c15a7000d60e58b6fc9442c3c9a9e5ac458fb316cd443dc09df32cf16d33d2dc56fb1bbd340b2127f937a04bbc9b00d10179ad9033414c9e06fb4a2f9206c77f25c5f863ec6b427a5b222d2af3e5ad77d3e090cae2c96d4be4f9ee81390254031cee4fb01af22777a7e737e3cf62d090f6e6e5e1f30d3c54663ab3771e2";
		cipherHex += "39e69fe7807a7c62cf7083977649fe048cbcbf6b5702726a45386be66269f62c405c405c9c06de58f5dc3110c18a99d6b13c301826643704cc051072a2d43edd9a7d4171cb36c5d59d748d43b4ed35ab267af6f1b631370581632b2077897487e0b5294f5b91cdb48b0b37282ed9846e42b7ca34f23fb0cc666544daba4b1df92981ea78f59f0690baa218acefb4c816e8d4263b96239e0011cbca928aa036366a07b87cf714ab46801edbf6f61eaa05685b9b6ec83cdfbd28f3b780bd4fe7740b102db9989bcc3a35befca277202"

		function hexStringToBytes(input) {
			for (var bytes = [], c = 0; c < input.length; c += 2) {
				bytes.push(parseInt(input.substr(c, 2), 16));
			}
			return Uint8Array.from(bytes);
		}

		function removePadding(input) {
			padAmount = input[input.length-1]
			unpaddedSize = input.length - padAmount
			return input.slice(0, unpaddedSize)
		}	  

		// Código de desencriptación. ivHex y saltHex no cambian entre webs. Siempre uso la misma.
		const saltHex    = "55de388d8fd8e67b6da0e68d4022e444"
		const ivHex      = "05998ad87dde9461c89b50cc97ebbb8e"
		let salt = hexStringToBytes(saltHex)
		let iv = hexStringToBytes(ivHex)
		let password = new TextEncoder().encode(texto)
		let passwordKey = await window.crypto.subtle.importKey("raw", password,{name: "PBKDF2"},false,["deriveKey"])
		let key = await window.crypto.subtle.deriveKey({name: "PBKDF2",salt: salt,iterations: 1000000,hash: "SHA-1",},passwordKey, {name: "AES-GCM",length: 32 * 8, },false, ["decrypt"])
		let cipher = hexStringToBytes(cipherHex)
		let decryptedBuffer = await window.crypto.subtle.decrypt({name: "AES-GCM", iv: iv, },key,cipher)
		decrypted = removePadding(new Uint8Array(decryptedBuffer))
		plainText = new TextDecoder().decode(decrypted)

		
		datos_brutos = plainText;
		
	}


 function recopilaSeleccionados(){
		resultado = '';
		espacio ='';
		var elem =document.getElementsByClassName("selected");
		for (const element of elem) {

			if (resultado.length!=0) espacio =' ';
			resultado = resultado +espacio+ element.textContent;
			};
	return resultado;
}


function estaPalabra(frase, palabra){


let patron = `\\b${palabra}\\b`;
let regExp = new RegExp(patron, 'g');
let esta = regExp.test(frase)
let result = esta ? true : false;
return result
}

			function CambiarPrecio(precio) {	
				let nuevo_precio = parseInt(prompt("Introduce el precio", precio));
				if (nuevo_precio != null && !isNaN(nuevo_precio)) {
					dibujaCuota(recopilaSeleccionados(), nuevo_precio, VR);

				}
			}
	
	function devuelveValores(indices) {
	    const indiceArray = indices.split(' ');
	  let resultado = datos;

	    for (let i = 0; i < indiceArray.length; i++) {
			resultado = resultado[indiceArray[i]];
	    }
	    return resultado;

	}

function showSelectedItem(item) {
const container = document.getElementById('list-container');
		

	x = parseInt(item.parentElement.parentElement.id)+1;
	const nombres = devuelveValores(recopilaSeleccionados());
	const nombres_valores = Object.keys(nombres);
	if (nombres_valores.includes('PVP')) {
		precio = nombres['PVP'];
		VR = nombres['VR'];
 		dibujaCuota(recopilaSeleccionados(), precio, VR);
	}
	else
	{
						let txt_resultado = document.getElementById("resultado");
				txt_resultado.innerHTML = '';
container.appendChild(generateHorizontalList(nombres_valores,x));
		
	}
}

function generateHorizontalList(items,nivel) {
const list = document.createElement('ul');
list.classList.add('horizontal-list');
list.id = nivel;
items.forEach(item => {
const listItem = document.createElement('li');
const button = document.createElement('button');
button.textContent = item;
button.addEventListener('click', function() {
const selectedButton = list.querySelector('button.selected');
const nivel_actual = parseInt(this.parentElement.parentElement.id);


	for (var i = nivel_actual+1; i <10 ; i++) {
		var elem = document.getElementById(i);
		if (elem) elem.parentNode.removeChild(elem);
 }

		
		
if (selectedButton) {
selectedButton.classList.remove('selected');
}
this.classList.add('selected');
showSelectedItem(this,nivel_actual);

});
listItem.appendChild(button);
list.appendChild(listItem);
});

return list;
}

document.addEventListener('DOMContentLoaded', function() {
	
const container = document.getElementById('list-container');
const cuerpo = document.getElementById('cuerpo');
const sinpass = document.getElementById('sinpass');


cuerpo.style.display="none";
sinpass.style.display="none";
		

	//const nombres = Object.keys(datos);
	const nombres = ['PlanMy Mac','PlanMy iPhone'];
	
container.appendChild(generateHorizontalList(nombres,0));
	
});

			function dibujaCuota(modelo,precio, fv) {		
				
				
		  		if (modelo.includes('iPhone')) {
				      rate = 6.95/100/12; 
				      nper = 24;
				}
				else
				{
				rate = 7.45/100/12;
				nper = 36;
				}

				pv = -precio-18;
				pvif = Math.pow(1 + rate, nper);
				pmt = - rate * (pv * pvif + fv) / (pvif - 1);
				intereses = ((pmt*nper)+fv)-precio;
				codigo_enlace = '<a class="link_precio" title="Pulsa para modificar el precio" href="#" onclick="CambiarPrecio(' + precio+');return false;">';	  
				texto_resultado = 'Importe: '+codigo_enlace+'<b>'+precio+" €</b></a><br/>";
				texto_resultado += nper +' cuotas de <b>'+redondea(pmt)+ '€</b><br>';
				texto_resultado += 'Y una última cuota de <b>'+redondea(fv)+' €</b><br>';
				texto_resultado += 'Pagando <b>'+redondea(intereses)+ ' €</b> de intereses<br>(incluidos en la cuota)';
				let txt_resultado = document.getElementById("resultado");
				txt_resultado.innerHTML = texto_resultado;
			}
	 
			function redondea(valor){
				if (Number.EPSILON === undefined) {
					Number.EPSILON = Math.pow(2, -52); //Hay que meter esto para que funcione en IE11
				}
				return (Math.round((valor + Number.EPSILON) * 100) / 100);
			}

			if (localStorage.getItem('password')) {
				pass = localStorage.getItem('password');
			} else {
				pass = prompt("Contenido protegido. Introduce la contraseña: ");
			}
			decrypt(pass).then(function() {	 
				datos = JSON.parse(datos_brutos);
				localStorage.setItem('password', pass);
				// Hace visible el cuerpo de la web, para que se pueda usar el programa. Los datos desencriptados se guardan en la variable "datos"
				document.getElementById("cuerpo").style.display="block";
				document.getElementById('cargando').style.display="none";
				
		   	 }).catch(function (error) {
				localStorage.removeItem('password');
    				console.log("No se han podido cargar los datos. Se borra la contraseña guardada.");
					document.getElementById("sinpass").style.display="block";
					document.getElementById('cargando').style.display="none";
					
 			});
			


</script>
</head>
	<body translate="no">
		<div class='aviso' id='cargando'>Cargando...</div>
		<div class='aviso' id='sinpass'>No se han podido cargar los datos.<br><a href="#" onclick="location.reload()">Actualiza esta página</a> e introduce la contraseña correcta.</div>

		<div class="cuerpo" id="cuerpo">
			<h2>Simulador PlanMy</h2>
<div id="list-container"></div>
			<br>
			
			<div class='aviso'><b>Los valores son aproximados.</b> <br>Por favor, no imprimáis esta hoja.</div>
			<div class='aviso_mini'>10/11/23: Valores actualizados. Válidos hasta el 05/01/24</div>
			
			<div id ='resultado' class="resultado">
			</div>
</div>
</body>
</html>
