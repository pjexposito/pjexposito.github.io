<!DOCTYPE html>
<html>
<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="UTF-8">
		<title>Simulador PlanMy</title>

		<style type="text/css" media="print">
				body {visibility: hidden; display: none;}
		</style>

<style>
    h2 {
        font-size: 1.8rem;
        margin-bottom: 0.7px;
    }
			#cuerpo {
	            line-height: 1.4;
				
				width: 60%;
				height: 100%;
				visibility: visible; 
				display: all;  
				margin: 0 auto;
		        font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
			}
			
			.aviso{
			    text-align: center;
	            font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
	            font-weight: normal;
	            font-size: 1.5rem;
				color: #616161;
			}
			.aviso_mini{
			    text-align: center;
	            font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
	            font-weight: normal;
	            font-size: 0.8rem;
				color: #919191;
			}

.horizontal-list {
display: flex;
list-style-type: none;
padding: 0;
width: 100%;
margin-bottom: -11px;

}

.link_precio:link, .link_precio:visited {
  background-color: #f2f2f2;
  color: black;
  text-decoration: none;
}

.link_precio:hover, .link_precio:active {
  background-color: gray;
  color: white;
}

.horizontal-list li {
flex-grow: 1;
}

.horizontal-list li button {
width: 100%;
background: #f2f2f2;
color: rgba(0, 0, 0, 0.6);
font-size: 1.3rem;
cursor: pointer;

padding: 7px 10px;
margin-right: -1px;
border: 1px solid rgba(0, 0, 0, 0.2);
box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);

}

.horizontal-list li:first-child button {
  border-top-left-radius: 5px;
  border-bottom-left-radius: 5px;
}

.horizontal-list li:last-child button {
  border-top-right-radius: 5px;
  border-bottom-right-radius: 5px;
}

.horizontal-list li button.selected {
background-color: #c1c1c1;
color: #000000;
box-shadow: none;

}

			.resultado{
			    text-align: center;
		        font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
		        font-weight: normal;
		        font-size: 1.7rem;
margin-top: 20px;
			}

	@media only screen and (max-width: 600px) {	
        h2 {
            font-size: 1.2rem;
            margin-bottom: 1px;
        }
		#cuerpo {width: 95%;height: 100%;visibility: visible; display: all;  margin: 0 auto;}
		.horizontal-list li 
button { font-size: 0.9rem;}
.resultado{font-size:1rem; text-align: left;}
.aviso{font-size: 0.8rem;}
}
</style>


		

<script>



	let datos_brutos;
	
	let datos;
	
	function borrapass(){
		localStorage.setItem('password', '');
		console.log('Contraseña borrada')
	}
	
	async function decrypt(texto) {

		// Este es el texto de apoyo del programa. Está encriptado por el tipo de datos que se usan
		let cipherHex = "cc3dc6d6ac70a0726b899d7a98fa314cb073807df2f151a11e4d5286ae0d1ec3eaf45c660632908a4c1d955253afe4e0d82836abac5233cce5b8b1cedbe057ef3eb0d757e1bcb5aaba92a7288e09c381b901050971f159d6936daa35e471ed0a89fcf717df6c65e4fbda14c4bffcc0cc3c564122cf8e2467d97f03ee9be20718843b7b4dfdf82d63983e7b04206b9904ac01fcab1e5b93d5d4dc48745a1a5d70ee3741247c69764e7b6a3322146bcaa02d0e207afb99cf04711b13ff57fb6a0b93ba81ebd63fe3903caad3208528318c64e43bb6071e61eec19cf0a7b761bb02d4fb25646c3ae4b1f39ece9f329d41b35d136817674c8e45b0d08850d9b95de908892826c0130a0851c4e81bf407fcdd8e30906dd3946a6fbbc77f8b103b5e5d8be8e5d621696397bc76b92694822f9ae9d202a93ac9bf0ae93d059848c002afdd92501c484281861c0d644b7d3054547c19d64db7d489bc0c0ae1cb69f41e5013c7c78c84a4b11fc35fc907cbb34495cafa4e1f32b7e24a093e9c1fd1dae4e7d332ec2d795634d8b18b7a6c7dfacd6127b373e853d8951d44668bb168ae3f3d6c7807a787b548301177d48da2f9e35f8d41a764abdadd4efdb3ea36344593de119f90d6d8fd039094b7adf9d525d3bcf1b9b131b86359a0260bfcc7fd507616a6a769b120af6ff664121b0adf703cba6a8040eac18863f055aec0245ecfcfcd2b097e36db45b08a20c873dc75ef656aea5415fa5ddce28dcc507ad828475f5164c122e2199ff5e4b7469808fb163b6aa45c76cc7e930f0118bb1772bc695a836f6557042ec5c7d9517a0b4c8a7ec1b22f59cf99efc9f117315ffaf42f860b99c2b2ff1f6f1b0723ced76f0bb465591cf9c7335fb39e9af280caae16f9e5dca2b20dd401f59d659c01ecec5bbffdd9f7d1fa291e8c79badd43b6bb1a1397115dd084588ccbf1d2626f6dd483e0f56242b6832e37d3024e42e2ca74ea59d37232bcff06a408ef0b8d406c0fd4bfb59589b22815ab4550538ffec64c6f01953ab4f18711db3968bd28294064c73f8e546ea5295b5cece4dc8a706c0bd8f56d2d5b6ac1169092603564515f6c61b6ab10a7ce16717b27dae60751d8e5d4501cc3752b6cf0724955a1ccb737ad9f0aba35967b86937f3191cffe04152c7b37ea2d1ecf975c98d0b663e295397adfc0c42d482946999903b9ad79e6d1424d658226d75e56c371b059b13ceb347fe3dc9467835ee2f2e7beb06a26571fc11b1e33e90e81e5c50974b1d33191315ca52db6f4812e2e0e213e45bfe9d6fb72cbbcd4e01572dd3fa972c5149fcebd4c67118f1ebd491b476338966942bea38947feef90e1e1f0eb4abd463b59bd63fb92432a18f4557bdcf94d85ac27e0f60b41d452b54a2ae4dceb00e3a09d7c9eb97c88caede9129fa1d37f79faa8219478f98685ee8c63be5dc7e0f83d8095eac2b43dfcef246bd6a4334f09160c92e9525137aeb414ce38ac3e5e83af641cbafd2593d961ebd4d2f251dd82cf185c7b6474f7ff5fdd3e120c07105b05ae4f0b30f76921ff0dfccd2afe5c136a37380a917157afd826808f0d979cc84f7c0339e0369b8044c2877483d8435312d4a98cb9154732ec67cca59bce73715ad5cf7062ab86473be8c29f05d7dea240e457442e8ca93f4d7627d5182ee73c712037b0e9cfb086c20eeca573a0619bbf21f967003dfab2112dfd6b16c0ea90b13ef7d03f5811cd712ac95c83409e8a4389d30c766a89134ed1774d97e60f92eb4c4fe9f71e5b07d9266dc160f7daf2f36dbf775d42b06c490de3e96423a8fe67b60106d8fab4a37900d4f9d95a1ad04922099bacb175b87f9961d48cdb3982b843c2570866f4e72929f1dddc7eddbd4c74a1fee639fe60300b7c66c219891cc7362a9692a58d2ba386bc551215724eb01fec33d84fc5b502a714ffc63ea8e30ae367a0dd30ba9011ac089f0dcdcb50b5cd122df86b5f9263a9eaee98963c8c2c1a28c72e9a53110db0f465417a56616923a155ae529ba5347ce32a26822900076118b0aec7ddaa92b6d52fa6654f4ceeb774f88bf7f71e331363bc669484a9d0c383d7b96b271ae77e2b05aabe378b7bec7ff8973f5ec9af5cfd58f8263b3bb7d167e91ce735fa8fedb46560680c537d59110cf8e4948e8fa81459bb41b8fb8a19e551b1e1f335fed0009540dd42f3ea4360f09c68c3592335140b1989266ab8df37a269984f03e7766c6611437894c76d60059606e8a4ffbc9e63a148948e2acb9ffeba4842127b42eb770fbfbc1e7b81e6461dcd1d5917854ad92f8a12292a6dbc6a606c52ba8f1751ff0c4d768591833598504eb73190bd8b4d2afcd46f7e77d90e24b49739dc613c4f37ba476832a3b3e6f3ced0a082347678a1d4a8f10171b0a8c5ec3466adeff7d581257b97f8923cd211d5b4ffaecb958bba36700b2e74bc4c5075d6076ebbeb48050366f8c634c943b0b6bef6e1c6f0f7f45303fd12755a3115ad0a9eac2f0884c1255fd17099dde18e133f9a39bf0b7395c93beee57c1af262935655c343afa7723356c3081798f5ece2c46db6de63de785e7629faea0f73f9ab2e228fa23d21abace6852f4061c6d945ed38c353859766570be772c6d8e47ce9c2cc9fec6a4978c1fe727f473ff967b1275a277d9ed17cd57de6c01a7719c48c12cb28ba45b0269c56881e5ee429e062951b3a8c190892e76a4163223ca5c45998153b763496b53a1a5effd88e27bc134b2d2be614fe29dea091eb9c6d38b6dd387a61a2806a51e4bcc25e6929662fa8b1311d5a58ed8801f5f3fbe8c4ca3469d09b53a2";
		cipherHex += "c90bb70987b98ef27eb478a80044c4153630ac5e5f945698efec04ebb38d4b1ad85937041450f0c7ee5d0d9ccc9c7421715e0defa91fcc1c5eb9b27c96509de228e74b5fdd0811758d73094946ca5483dfb310ab223f2140fb64555560c414501d97d6842af89fb764580c02b4590d8cc9bb508fc8ccdb05d203191c09508bb475ee4b6f174d0f86f5a40d8d26431044c154c8d453d6de199ca5e0ba33fd06418822ecb98db3192b2b5f38bea30478cd5fa265b8fa6ef181b6ef563d1bb2f53db30983eda413c7329e02301f25f9510aa7f5a10e218997dc3fdb87dbfce7f2b53ef8a2429d8b0946237a99b9168d3d161b606beb60250c4837701dc6b94ae01a958c7dadaa3520c6851bd7a1680b33a0948467eb7795699923ac9765ab3dc77c14adc81c8f61dd13480155aeb818f84e184e2914c0347cf32441b65cb5cb942bbe3097bca88eed4e536e0670ed26f83c8201b4fc4a4af562d87824fe0a3df5b45b4796e24e8dab8f5d04d9e43613c41ae100c62ec79915a3ce535c32e1557976f4b776c375146d166408f1c324ac63d31d010953a96b33663db8304f39cab2021d6cea10e69afc6caf758088a076968a19256f6f1d18f0f09813a34ef0749971f9a1ec72281f5f2e94c865c06e8619151fed79f49d7139e2475bedb85d66d7b013df41cdce5c3721636a65adcb5cc824ccfd63096e5092674e896d36446fe2b2479cca10633870d6f1e305aa81a0b225329dec7c8abbd690e2a91e57fffa1f9e0a35e938654b2a3bed1c1fed5db4e8493b4f6837dc20dafb843d994e47c2c0dbe97ce94e17078ca74f97dc382aa4d8255762226f26671bb6390d84bbed239f1dc96eef23c6b18134b2f0f8658de551122c244e1adc867921a7f50e7d2aba351af4a1eb51c686cc0dcd10368a0c570748be32e2d66e5544a65f7ade371cb76df72793005f427445a5cb5492d00a388bce4f99dd19c8dbb214182acb3e31bed8a4fc3d297a9a1ca81911e9c20c7d7b666ea890eea8f81e19ea02be2feadb806a2cd670ffc9cf3cee942e9301262a721be81e1a9daab7e8b21dd5649ee94d797997acc7ca5da5e06b2f6062c15b8347368808760a5339a7877e8673292291104521e35fe4af0b0e9e19d8341db073fede4836702a159289b965255c525ba7be0a95313cc44e9d7f86a681a41ca9f613acd67247ca162ab39253959d7d3680b5145a3d63cccfb34cc41bc804e8fdbe4d3c6c4965c1e4b4535c527756e64489f3f6398e5f1576ee737b1e04047e5487e6c7d68f3a800c6495a303b4ead3d4bf2611587732695db5aaa8d290c8ea4e3af925dbee2bff00f7ce946ddbd8f16ce9fcfb3274a3b509f1fd83fe62231ff0e032f938c2c1c9d8d15c2f81936c37deab74fd71480354192ebd98d273559997a935f9f8aae8a4a2cfe7fe590dfc10065d3a5a0949522d09c8ad842b26225c7a498959115cf213c5a87f28259a64ae0ab3c049b3fd9e0f8ab5ed02f140e9ff2287d6cab3f5891d23b1e67fc47fa8dca317d1a5d2b4f053e86a5d487fc91ed1a4b780aec98287d296960553ebbc30c15e9bf6a2e9f70c75d5e7eb3e985dd59f4866345e5040b6e269e54c57a14779318bf36b129998afad90f92db8cb105865cddef3219778cbba16faa4362d4d2f343552ee659a2124b9311691e20c45716a8c30c92ff31dc60b1fddd879dcf5f464b86f20cf5ef1a092e6cadb76100889c1ca9ecbb102b5fe6cbf36e4fcb2ed26ab9333293d5c26936b28c9a9a17665a308bf97c9b6dfa95a79cf871b3807efef331a584e32e8d0ae3058113457b7ba4124e2b8632024d0a67e53b653769f5e66de843fa4ad2bb4c656e18af603653eeea829c11e4c7118463944f63da3cdebcbce375a349b56155a18c43be5d12d4ed5e7ece5883a50567520529c02011895e7adea3a301ed26ae0a999c69b98cb8804844624278545aa950afcca9794f175ee7022394b2916d56e56976e2f534b4dd8bc1b9983d4eeb31613b406e0277f2ab58baaa31ffa4bcb2ae4512ea998adf0e15a776219cb327b4a04304518739544cc19cc33f44ee83276d36d37967d2bc27c9d5a27731482b8065cf56e453fd0378c1e31a956c4c45d60ba1a047f61bd9429e5a32ce2ea3ecd3bbcbe5fd43f505e2736fbe5088b0f8cb0ac1e3a8af05d42834d31adbe6b2d8a731080c7eee3a98d1cf1a810ff209ed1221dc3d8faa6c49f1b44e312e336d0fb1a49e29c2c9ece3f3225b97716ee182fc0f8606fc089e65527aa0708b0049456c2d284ce05235d4ae8a8607c6341d192c5f8f8e5674e338429479a5602dec3975bc8ef680b200945c1c01fc2d825a0"

				// Funciones de apoyo
		function hexStringToBytes(input) {
			for (var bytes = [], c = 0; c < input.length; c += 2) {
				bytes.push(parseInt(input.substr(c, 2), 16));
			}
			return Uint8Array.from(bytes);
		}

		function removePadding(input) {
			padAmount = input[input.length-1]
			unpaddedSize = input.length - padAmount
			return input.slice(0, unpaddedSize)
		}	  

		// Código de desencriptación. ivHex y saltHex no cambian entre webs. Siempre uso la misma.
		const saltHex    = "55de388d8fd8e67b6da0e68d4022e444"
		const ivHex      = "05998ad87dde9461c89b50cc97ebbb8e"
		let salt = hexStringToBytes(saltHex)
		let iv = hexStringToBytes(ivHex)
		let password = new TextEncoder().encode(texto)
		let passwordKey = await window.crypto.subtle.importKey("raw", password,{name: "PBKDF2"},false,["deriveKey"])
		let key = await window.crypto.subtle.deriveKey({name: "PBKDF2",salt: salt,iterations: 1000000,hash: "SHA-1",},passwordKey, {name: "AES-GCM",length: 32 * 8, },false, ["decrypt"])
		let cipher = hexStringToBytes(cipherHex)
		let decryptedBuffer = await window.crypto.subtle.decrypt({name: "AES-GCM", iv: iv, },key,cipher)
		decrypted = removePadding(new Uint8Array(decryptedBuffer))
		plainText = new TextDecoder().decode(decrypted)

		
		datos_brutos = plainText;
		
	}


 function recopilaSeleccionados(){
		resultado = '';
		espacio ='';
		var elem =document.getElementsByClassName("selected");
		for (const element of elem) {

			if (resultado.length!=0) espacio =' ';
			resultado = resultado +espacio+ element.textContent;
			};
	return resultado;
}


function estaPalabra(frase, palabra){


let patron = `\\b${palabra}\\b`;
let regExp = new RegExp(patron, 'g');
let esta = regExp.test(frase)
let result = esta ? true : false;
return result
}

			function CambiarPrecio(precio) {	
				let nuevo_precio = parseInt(prompt("Introduce el precio", precio));
				if (nuevo_precio != null && !isNaN(nuevo_precio)) {
					dibujaCuota(recopilaSeleccionados(), nuevo_precio, VR);

				}
			}
	
	function devuelveValores(indices) {
	    const indiceArray = indices.split(' ');
	  let resultado = datos;

	    for (let i = 0; i < indiceArray.length; i++) {
			resultado = resultado[indiceArray[i]];
	    }
	    return resultado;

	}

function showSelectedItem(item) {
const container = document.getElementById('list-container');
		

	x = parseInt(item.parentElement.parentElement.id)+1;
	const nombres = devuelveValores(recopilaSeleccionados());
	const nombres_valores = Object.keys(nombres);
	if (nombres_valores.includes('PVP')) {
		precio = nombres['PVP'];
		VR = nombres['VR'];
 		dibujaCuota(recopilaSeleccionados(), precio, VR);
	}
	else
	{
						let txt_resultado = document.getElementById("resultado");
				txt_resultado.innerHTML = '';
container.appendChild(generateHorizontalList(nombres_valores,x));
		
	}
}

function generateHorizontalList(items,nivel) {
const list = document.createElement('ul');
list.classList.add('horizontal-list');
list.id = nivel;
items.forEach(item => {
const listItem = document.createElement('li');
const button = document.createElement('button');
button.textContent = item;
button.addEventListener('click', function() {
const selectedButton = list.querySelector('button.selected');
const nivel_actual = parseInt(this.parentElement.parentElement.id);


	for (var i = nivel_actual+1; i <10 ; i++) {
		var elem = document.getElementById(i);
		if (elem) elem.parentNode.removeChild(elem);
 }

		
		
if (selectedButton) {
selectedButton.classList.remove('selected');
}
this.classList.add('selected');
showSelectedItem(this,nivel_actual);

});
listItem.appendChild(button);
list.appendChild(listItem);
});

return list;
}

document.addEventListener('DOMContentLoaded', function() {
	
const container = document.getElementById('list-container');
const cuerpo = document.getElementById('cuerpo');
const sinpass = document.getElementById('sinpass');


cuerpo.style.display="none";
sinpass.style.display="none";
		

	//const nombres = Object.keys(datos);
	const nombres = ['PlanMy Mac','PlanMy iPhone'];
	
container.appendChild(generateHorizontalList(nombres,0));
	
});

			function dibujaCuota(modelo,precio, fv) {		
				
				
		  		if (modelo.includes('iPhone')) {
				      rate = 6.95/100/12; 
				      nper = 24;
				}
				else
				{
				rate = 7.45/100/12;
				nper = 36;
				}

				pv = -precio-18;
				pvif = Math.pow(1 + rate, nper);
				pmt = - rate * (pv * pvif + fv) / (pvif - 1);
				intereses = ((pmt*nper)+fv)-precio;
				codigo_enlace = '<a class="link_precio" title="Pulsa para modificar el precio" href="#" onclick="CambiarPrecio(' + precio+');return false;">';	  
				texto_resultado = 'Importe: '+codigo_enlace+'<b>'+precio+" €</b></a><br/>";
				texto_resultado += nper +' cuotas de <b>'+redondea(pmt)+ '€</b><br>';
				texto_resultado += 'Y una última cuota de <b>'+redondea(fv)+' €</b><br>';
				texto_resultado += 'Pagando <b>'+redondea(intereses)+ ' €</b> de intereses<br>(incluidos en la cuota)';
				let txt_resultado = document.getElementById("resultado");
				txt_resultado.innerHTML = texto_resultado;
			}
	 
			function redondea(valor){
				if (Number.EPSILON === undefined) {
					Number.EPSILON = Math.pow(2, -52); //Hay que meter esto para que funcione en IE11
				}
				return (Math.round((valor + Number.EPSILON) * 100) / 100);
			}

			if (localStorage.getItem('password')) {
				pass = localStorage.getItem('password');
			} else {
				pass = prompt("Contenido protegido. Introduce la contraseña: ");
			}
			decrypt(pass).then(function() {	 
				datos = JSON.parse(datos_brutos);
				localStorage.setItem('password', pass);
				// Hace visible el cuerpo de la web, para que se pueda usar el programa. Los datos desencriptados se guardan en la variable "datos"
				document.getElementById("cuerpo").style.display="block";
				document.getElementById('cargando').style.display="none";
				
		   	 }).catch(function (error) {
				localStorage.removeItem('password');
    				console.log("No se han podido cargar los datos. Se borra la contraseña guardada.");
					document.getElementById("sinpass").style.display="block";
					document.getElementById('cargando').style.display="none";
					
 			});
			


</script>
</head>
	<body translate="no">
		<div class='aviso' id='cargando'>Cargando...</div>
		<div class='aviso' id='sinpass'>No se han podido cargar los datos.<br><a href="#" onclick="location.reload()">Actualiza esta página</a> e introduce la contraseña correcta.</div>

		<div class="cuerpo" id="cuerpo">
			<h2>Simulador PlanMy</h2>
<div id="list-container"></div>
			<br>
			
			<div class='aviso'><b>Los valores son aproximados.</b> <br>Por favor, no imprimáis esta hoja.</div>
			<div class='aviso_mini'>26/10/23: Valores actualizados</div>
			
			<div id ='resultado' class="resultado">
			</div>
</div>
</body>
</html>
