<!DOCTYPE html>
<html>
<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="UTF-8">
		<title>Simulador PlanMy</title>

		<style type="text/css" media="print">
				body {visibility: hidden; display: none;}
		</style>

<style>
    h2 {
        font-size: 1.8rem;
        margin-bottom: 0.7px;
    }
			#cuerpo {
	            line-height: 1.4;
				
				width: 60%;
				height: 100%;
				visibility: visible; 
				display: all;  
				margin: 0 auto;
		        font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
			}
			
			.aviso{
			    text-align: center;
	            font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
	            font-weight: normal;
	            font-size: 1.5rem;
				color: #616161;
			}

.horizontal-list {
display: flex;
list-style-type: none;
padding: 0;
width: 100%;
margin-bottom: -11px;

}

.link_precio:link, .link_precio:visited {
  background-color: #f2f2f2;
  color: black;
  text-decoration: none;
}

.link_precio:hover, .link_precio:active {
  background-color: gray;
  color: white;
}

.horizontal-list li {
flex-grow: 1;
}

.horizontal-list li button {
width: 100%;
background: #f2f2f2;
color: rgba(0, 0, 0, 0.6);
font-size: 1.3rem;
cursor: pointer;

padding: 7px 10px;
margin-right: -1px;
border: 1px solid rgba(0, 0, 0, 0.2);
box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);

}

.horizontal-list li:first-child button {
  border-top-left-radius: 5px;
  border-bottom-left-radius: 5px;
}

.horizontal-list li:last-child button {
  border-top-right-radius: 5px;
  border-bottom-right-radius: 5px;
}

.horizontal-list li button.selected {
background-color: #c1c1c1;
color: #000000;
box-shadow: none;

}

			.resultado{
			    text-align: center;
		        font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
		        font-weight: normal;
		        font-size: 1.7rem;
margin-top: 20px;
			}

	@media only screen and (max-width: 600px) {	
        h2 {
            font-size: 1.2rem;
            margin-bottom: 1px;
        }
		#cuerpo {width: 95%;height: 100%;visibility: visible; display: all;  margin: 0 auto;}
		.horizontal-list li 
button { font-size: 0.9rem;}
.resultado{font-size:1rem; text-align: left;}
.aviso{font-size: 0.8rem;}
}
</style>


		

<script>



	let datos_brutos;
	
	let datos;
	
	async function decrypt(texto) {

		// Este es el texto de apoyo del programa. Está encriptado por el tipo de datos que se usan

		let cipherHex = "cc3dc6d6ac70a0726b899d7a98fa314cb073a451f0f01cf40e4d25ccae760c93ff897711153bc9920f10ea5647b7a5b9c84d56bcec4a3882f1d1cbbcaf8844e73cbacd41e5a7ea81c492a55dee6dcf8ff45e400a61895dd6936daa57871788529af1b50ca3186394e3d115cab6fccec06d583548c2812667c96b48ffb698750f8f3b0c1de6ee74179a4a11122b638102a552b9e34f55e7eea6871866584f4778e7221e32257a00092d7d33555d6bc2ee397b776e8680cf6e5c69619330e0691684d5ebe7d43bfc8044c8c6679a33319617b764a05e09008ad6dce8a8f57ac776d28b3d6f6d31f2affad69f9146980aef00046142714dc60e8acf8648f2e9629d62d03021c1081c5125dbf803ff4cedc18231aa23d398250a89b315d2085a3e3c91fce9d134671793cc6eb7219582259ce9835db029ba911ae93d05985bf33ee1c599130a42598ff4520d08627d5a3631660dd445fc90d8b27869f7d362b60f3313173a25f6e0ea7a9b06d149d8d155a7cafa0c0b5bcd903e612e921adfc4f2e3c86dc753793b6b8eef87712222e4da6634b373e853d8951d44668bbb6ea32b31021f09bfe0d15a2417759c8fb9feaa65c341d02d6b0a0e53bef1ff3a764b80dc219f909cc89a7bf187f0e3b3cd3fb0edaafcb15d916320fc785ef0c9b10f395ebcc23aa538ee36847f70dbb06b107aec64986d9ad683608004a2c96601b3bbab3d742f24d506bce243b473b01ff96671fd3769e15690fa9fd3372b876f105f565bf769fa10d6e0eeac48ea46fb7a126ace3217dc6a920f4549b5636dacb1eb32122a1c156992c7de315f4b54cb27b3b4292bd797e8c4f0152b3c84f443e51994ddb0fc533c561f7ce3d87d54a23c364cabc7335fb3849afa80caae16f999dcb5a2029964c7e90fc5198d8a3fa4ebcc90bbf62b1a9768c2bc58f1a60c198c124d97d35891af8ec5696c1b8198f6ac1640c2e93d34de184e54a7d37afd3eb37232f6e460dc68f94c905613041a1d6697d9e73513ac59254c81e68c3a5d75ff63ac90e477c12d61b136323a14b3579f5c69ba204119a5b5d2fb364d0d93a03435701edc064820d15231090f5b1ca5c546b5c54367120cf7e81f2685bd805c1e8d7b38089a72491fb3acd049b79646a423e2654645a85eca85e1070a2a0928e43557d8f128f289ae0180f7236ed6c6df36325932f18e09bab176fb950c4d65827aab0d17db30e92baa5de6360985bb8279943ef7b2ffb6fd715833799e0d0d3584548de78b0706b1d13191305aa63aace0aa502e7923244cd680fef865c8daf1a00d33844daf74b70c97cabf47731de179b3517926752c976d06edef9d18e3ffffeab5e5fb738e002b56f006a882417300df217ba8935e8aab2bfaf7124fa056c55222e4d7f11bafb8c23387ad37e2d0ab9b7eb4a1d03a24efab769479c2c2d6fe8028b252cadab63d8fdffab0d816fc854609cdb0355b1979729285374223adb65bcc29af7644e6fc1244e3e50ee7d91581c0daf94cd897c16c580b7c7ff4f345c33f590c07102a34a0011371ae1b419b68a4dd28b7476f1e3148129e7c58b6c13cdfa47397e5941a3e1031e638888049d6fa6d83b26e2160b8c898b71b52299402c2bdffab63655ed0807271a1ce0c64fe9b8c65f5e6a240ae42247ec6e24b252f3fd1155dab2e7e2639c28aaea09ecd42f7db12dc61f7df33f167193194d24e3bec6a16d89ec5ee28aec33b6c63d5303fae33fd55889a20e9c51a650ee31f4cdd3b0795f5758aab025f87ee1e5748bc1419ab39efb994917ba9623c29bc6151168c957e2ae4b122e5151c94e6e2f96e0ce8b9ac09079b3b4e229ba0bc05e3739436d48adf4b9ab340c4401d77dfc8763feab8802682ab1564a5f98361a7781c404a59b001c809c13d3ef3a6d5956ab0e4d22b07193e03a80481619801b1dd5bbf13fcb272bfa45de305c3bb55e2851cee06ed0dcfcb50b5ce1d3ae16a0e9c17c9fde2eecd2a986e0105bd5c8d581a7debfa7d6c0a240d0837aa4aa252dff67e2ded5e39c170100e2c14cef6d498aa99999540ad3c57679adf79f08ff8e71d66061fc860e49ca5d6cb97dbd60f780cf47c4749b1b73185098200ef9c3f48c1ed509a228a525321b5dc7bfa64836abd92fbc12e353053142a596d0ce2998d8e8dfc043cdb33a0ba997b8738bdece82691ae00f920cf4eeceb4d33e98b27da4d5c78030050894c47caad5bc378954f19e9766c6611437897cc6360059406b9aae8c09ec643effe8767b9f3d5ba43450b7c4af76219e6c81c0febf64a15d61857468b3eba59d203216561dd0b4d3315a49c761ca45f083bf1f9da2de6549e1984efa1df4d22d3947e7623ce6f40a3d721d42c2c264fdd497056c0a9e5ebdfb2dc96383f30eed6b8f74f2ea6f1aa8abf804198a1dad1756b95c4d228dc45c6b0cbdcd3d498de541907236cad2c3b7bce630fa0ff47074c64eccd7c8228f0d9b6a58ed7fe8ef45349ea167e5b3308bd1baeac2f4190a05d3ec23787cbe6860d5aae49a74a64f5ae45f4e9305fec79f05351b459a9d7092944cb5d019dbceff1a15bf6c622870a58705be2e40574f2be2243f1a25142b9a6e49322582c8cd914e328da50c4cf721a3093189fc0972da9d9d8d3e2792c08d9bf64044133f42eee6259370bcd9f2a8c65cdb47b671bb2dc01c87fba43b454845e891944e93eaa339b6f259c0100def77c58696a26a5cc178c020f042cd7a6587537f1c0e942a910562835ea729b76c8b090f0876d3de9cb616d00c6972a49eff1d437135b1247b8bb37144c41f99e2adaacedf9c6ca386792c432b2";
		cipherHex += "da65ae0985ed9e971ec660e91021a0713a3db14930ff58808d8f11ffb3850018ce5e1e4a1452a4d08f397f848d8d1445155200f2b37ba71246dbd967825d9dac7bae010e8234052b8d190004279543cdccba49b36f292b10fb64555508bd7647118cdac6269fe5c510301f0eb4561180add10f99decedf1da11c17044a5deed317ee4b25042b60f8e0b21ee340580657ae35c4dd539e9b1b8ac1f4a127f31e0b9e36e285cddc12b2898a3e9cee1c758044bd64bbe96cc181b6a5465a63d0e57aad1d82ecbe76f3428643267c46874007e3efba11208a80bb5fdb8791e8878ad724bfed0e829d680d1b4199b95e9a58514a3a34ac3725774e9292baacb0079276be8c76adb1393fc38b03fad11a6752b2999860e6339569fd44b8ea31b930926f7d86b41c846fc61b32545bb695688a2279582309c43538a22a35a71be3908324eb2b94f592c0ed391aaed6a3f065ba268c43b8f85447926498602fb1184397d1045187e74f82c0cf296c80fc5f77ad16ee4c8b67d29513b9ce3f75329655acc55fcf6ac62a536b18756ab2931e83380be6a630559126673029b3724172cc884f493c31a84d9af033e8228095e3fbf48fcc1a61350559a9e39f68f038a82d815a8da198183b1d5e208cd31fb01aee081f18f67ee8d36566fb54589cf54a6d9eb079f233bfa23d2023687376c2b55ca444d8f6790161038d7301c177536b7f3a49e09cee2f63383ac7f3ec06bde6c0b2257b8d8c04ecae918ff0ac15439ace6f864b208c5b1b502577f30e17f750d3ee0923442a2ca247b2a4c32289290c81c0b7c07ce222441798e555baf7442ad3dbf0e4de432c081703f7290680baeb4e8013d120fc41d7838134fde3910af1e53d713a264606cae10533aaba473579f37f4bfad3b5059e8cd7cd77ee7d8a32684b17ad3aaacd2b277a9b13250e87ada868e160c400201f3e6fa6854cd389785fe9d432cace138ad5c0141a2acb3e39bccfbee8160674827ef75f4cffc10a736c6569d9b5aeb0b9476bec04cc37e1d9826039d804fbb9d734ee92338b036c7b7c0be8196fb8eaafa9eb6fd362ecf146787297b9c9be59d5f8602b6b7fdc59ca166995181e3f5e39a7877ee7174147c90b4a63ed2de4ad0b0e9e1fde2309a458d1d0504b2f6d56c1d7e6737c4c525cd29b4a8d7065b6489b0d9ead84a216bcf867a8a66a4ecb1330ae921ac4936a3587c4311a252295bdb54ab603c30ae0fdbe4d3c6c4965c3ebb35350577756e644efa99361d7473e02ee07110d070a72418992c3a69734840d7b8da44db4bb8ca8ef20a3b09d116dc71715e2c583c0a92b08a970424cfee431add69f22cfd0892c9d94a22a17c6dc05f2ffc7e4793d0890f572e1368cd7b7b9b203399293643cb5eb0095285060357922b79b986e4e8084cd20b9e0a3aab0dca180a14f1ef61009367a2e61104a496ca8a18f226f3847673fbd29091de370aad66d206ad679b576e3f939abbc8807eef9fc0df71f958b22c99988a9fbcb1330d58c1a9c69a091af7eb188dcacf453ef14134813e01ebbc0d19abacaca92c988816546aba4398c45e591c3b6e11f75d5e8807eec358c872a095c525849f8fa72fc5f33b4076138c1e01576ffc7b9be94ff2cd38b64303cd5bd90499b76cff55abea436124f6561690f3dcb2e276ae6274fe3c016443e319b30c665e36b961162c4d813f1878608d97922cf42eadae292a2ca7812138fda858794af15b18c38da6ebde4999926dff920213f5538881158bdc1b17461ba00ec8bd3fac1b3282adffa02386dc29d4176395d38e0ceb95f26115837a0b55d23e8eb2f717bb2eb4157b956769f5e66da8735a4ad2bb4c656e18af6036537eda23ccf6a4801004d3947e024a884bac5de305945be160d1b41b63de3a3354dd6eef8fef24a243e662f5387061a5580b8b4f9394544b732b9b1b2b29beca19b0f884a3129f141da8d01f7c9888ff639ee217d451b2f64877a1ac3be9791185cc0fd42eb9bebbee4464ea305b7271c49a5f6f9b814af5cac01985126ad9fdbabef425a126ba75b6b5e04370f0d7d8527a87c9423ff04e4565daf6d389f79558c7cf173271975e3b40854bd725e22c059995e29a119dfba3f02e50c117d0cf39445cca346828a32c03ff6f01bd43f6f5c6d63a7b8dd25be89fff30863f8cc5dd26ea910eefc3235c36417f59d8bbbf0953785a864953a94d93c0aaca6facaa08b0f43e757e1259ce5003cb5885187ce551f57cb1b70fb1b32d1990b61d8ea81592aa14813bc0b936c8cd28b8415346938f0e9741c0c3dd1fea6ecf2e97b4255e77600d51d4af2f8bda07253c65c4ded9c5865e0f23c8072cef55aa66bb16105118f2054225bc0cf42a108067bc75ffd7c2722fa2e6fab02703a8b3cc643d7ee521b6edad83887e0ae9fa0d229da0cf8b0abec99b17ffc353d70e6f011ff5ec58de3589fe22df97dfc872e28aa02137fc6fc39fcd58c97d7104443d2e2d4a0cfe413267785d504416a59732fe78e01dd987c3c73d3f34afb342d7e6f49a71094dd9f775ef1f4226bd0e1991ae9ade0cf90eba0743581ec0f"
				// Funciones de apoyo
		function hexStringToBytes(input) {
			for (var bytes = [], c = 0; c < input.length; c += 2) {
				bytes.push(parseInt(input.substr(c, 2), 16));
			}
			return Uint8Array.from(bytes);
		}

		function removePadding(input) {
			padAmount = input[input.length-1]
			unpaddedSize = input.length - padAmount
			return input.slice(0, unpaddedSize)
		}	  

		// Código de desencriptación. ivHex y saltHex no cambian entre webs. Siempre uso la misma.
		const saltHex    = "55de388d8fd8e67b6da0e68d4022e444"
		const ivHex      = "05998ad87dde9461c89b50cc97ebbb8e"
		let salt = hexStringToBytes(saltHex)
		let iv = hexStringToBytes(ivHex)
		let password = new TextEncoder().encode(texto)
		let passwordKey = await window.crypto.subtle.importKey("raw", password,{name: "PBKDF2"},false,["deriveKey"])
		let key = await window.crypto.subtle.deriveKey({name: "PBKDF2",salt: salt,iterations: 1000000,hash: "SHA-1",},passwordKey, {name: "AES-GCM",length: 32 * 8, },false, ["decrypt"])
		let cipher = hexStringToBytes(cipherHex)
		let decryptedBuffer = await window.crypto.subtle.decrypt({name: "AES-GCM", iv: iv, },key,cipher)
		decrypted = removePadding(new Uint8Array(decryptedBuffer))
		plainText = new TextDecoder().decode(decrypted)
		// Hace visible el cuerpo de la web, para que se pueda usar el programa. Los datos desencriptados se guardan en la variable "datos"
		document.getElementById("cuerpo").style.display="block";
		datos_brutos = plainText;
	}


 function recopilaSeleccionados(){
		resultado = '';
		espacio ='';
		var elem =document.getElementsByClassName("selected");
		for (const element of elem) {

			if (resultado.length!=0) espacio =' ';
			resultado = resultado +espacio+ element.textContent;
			};
	return resultado;
}


function estaPalabra(frase, palabra){


let patron = `\\b${palabra}\\b`;
let regExp = new RegExp(patron, 'g');
let esta = regExp.test(frase)
let result = esta ? true : false;
return result
}

			function CambiarPrecio(precio) {	
				let nuevo_precio = parseInt(prompt("Introduce el precio", precio));
				if (nuevo_precio != null && !isNaN(nuevo_precio)) {
					dibujaCuota(recopilaSeleccionados(), nuevo_precio, VR);

				}
			}
	
	function devuelveValores(indices) {
	    const indiceArray = indices.split(' ');
	  let resultado = datos;

	    for (let i = 0; i < indiceArray.length; i++) {
			resultado = resultado[indiceArray[i]];
	    }
	    return resultado;

	}

function showSelectedItem(item) {
const container = document.getElementById('list-container');
		

	x = parseInt(item.parentElement.parentElement.id)+1;
	const nombres = devuelveValores(recopilaSeleccionados());
	const nombres_valores = Object.keys(nombres);
	if (nombres_valores.includes('PVP')) {
		precio = nombres['PVP'];
		VR = nombres['VR'];
 		dibujaCuota(recopilaSeleccionados(), precio, VR);
	}
	else
	{
						let txt_resultado = document.getElementById("resultado");
				txt_resultado.innerHTML = '';
container.appendChild(generateHorizontalList(nombres_valores,x));
		
	}
}

function generateHorizontalList(items,nivel) {
const list = document.createElement('ul');
list.classList.add('horizontal-list');
list.id = nivel;
items.forEach(item => {
const listItem = document.createElement('li');
const button = document.createElement('button');
button.textContent = item;
button.addEventListener('click', function() {
const selectedButton = list.querySelector('button.selected');
const nivel_actual = parseInt(this.parentElement.parentElement.id);


	for (var i = nivel_actual+1; i <10 ; i++) {
		var elem = document.getElementById(i);
		if (elem) elem.parentNode.removeChild(elem);
 }

		
		
if (selectedButton) {
selectedButton.classList.remove('selected');
}
this.classList.add('selected');
showSelectedItem(this,nivel_actual);

});
listItem.appendChild(button);
list.appendChild(listItem);
});

return list;
}

document.addEventListener('DOMContentLoaded', function() {
	
const container = document.getElementById('list-container');

		

	//const nombres = Object.keys(datos);
	const nombres = ['PlanMy Mac','PlanMy iPhone'];
	
container.appendChild(generateHorizontalList(nombres,0));
	
});

			function dibujaCuota(modelo,precio, fv) {		
				
				
		  		if (modelo.includes('iPhone')) {
				      rate = 6.95/100/12; 
				      nper = 24;
				}
				else
				{
				rate = 7.45/100/12;
				nper = 36;
				}

				pv = -precio-18;
				pvif = Math.pow(1 + rate, nper);
				pmt = - rate * (pv * pvif + fv) / (pvif - 1);
				intereses = ((pmt*nper)+fv)-precio;
				codigo_enlace = '<a class="link_precio" title="Pulsa para modificar el precio" href="#" onclick="CambiarPrecio(' + precio+');return false;">';	  
				texto_resultado = 'Importe: '+codigo_enlace+'<b>'+precio+" €</b></a><br/>";
				texto_resultado += nper +' cuotas de <b>'+redondea(pmt)+ '€</b><br>';
				texto_resultado += 'Y una última cuota de <b>'+redondea(fv)+' €</b><br>';
				texto_resultado += 'Pagando <b>'+redondea(intereses)+ ' €</b> de intereses<br>(incluidos en la cuota)';
				let txt_resultado = document.getElementById("resultado");
				txt_resultado.innerHTML = texto_resultado;
			}
	 
			function redondea(valor){
				if (Number.EPSILON === undefined) {
					Number.EPSILON = Math.pow(2, -52); //Hay que meter esto para que funcione en IE11
				}
				return (Math.round((valor + Number.EPSILON) * 100) / 100);
			}

			if (localStorage.getItem('password')) {
				pass = localStorage.getItem('password');
			} else {
				pass = prompt("Contenido protegido. Introduce la contraseña: ");
			}
			decrypt(pass).then(function() {	 
				datos = JSON.parse(datos_brutos);
				localStorage.setItem('password', pass);
		   	 }).catch(function (error) {
				localStorage.removeItem('password');
    				console.log("No se han podido cargar los datos. Se borra la contraseña guardada.");
 			});


</script>
</head>
	<body translate="no">

		<div class="cuerpo" id="cuerpo">
			<h2>Simulador PlanMy</h2>
<div id="list-container"></div>
			<br>
			
			<div class='aviso'>	Los valores son aproximados. <br>Por favor, no imprimáis esta hoja.</div>
			
			<div id ='resultado' class="resultado">
			</div>
</div>
</body>
</html>
