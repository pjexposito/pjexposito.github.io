<!DOCTYPE html>
<html>
<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="UTF-8">
		<title>Simulador PlanMy</title>

		<style type="text/css" media="print">
				body {visibility: hidden; display: none;}
		</style>

<style>
    h2 {
        font-size: 1.8rem;
        margin-bottom: 0.7px;
    }
			#cuerpo {
	            line-height: 1.4;
				
				width: 60%;
				height: 100%;
				visibility: visible; 
				display: all;  
				margin: 0 auto;
		        font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
			}
			
			.aviso{
			    text-align: center;
	            font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
	            font-weight: normal;
	            font-size: 1.5rem;
				color: #616161;
			}
			.aviso_mini{
			    text-align: center;
	            font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
	            font-weight: normal;
	            font-size: 0.8rem;
				color: #919191;
			}

.horizontal-list {
display: flex;
list-style-type: none;
padding: 0;
width: 100%;
margin-bottom: -11px;

}

.link_precio:link, .link_precio:visited {
  background-color: #f2f2f2;
  color: black;
  text-decoration: none;
}

.link_precio:hover, .link_precio:active {
  background-color: gray;
  color: white;
}

.horizontal-list li {
flex-grow: 1;
}

.horizontal-list li button {
width: 100%;
background: #f2f2f2;
color: rgba(0, 0, 0, 0.6);
font-size: 1.3rem;
cursor: pointer;

padding: 7px 10px;
margin-right: -1px;
border: 1px solid rgba(0, 0, 0, 0.2);
box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);

}

.horizontal-list li:first-child button {
  border-top-left-radius: 5px;
  border-bottom-left-radius: 5px;
}

.horizontal-list li:last-child button {
  border-top-right-radius: 5px;
  border-bottom-right-radius: 5px;
}

.horizontal-list li button.selected {
background-color: #c1c1c1;
color: #000000;
box-shadow: none;

}

			.resultado{
			    text-align: center;
		        font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
		        font-weight: normal;
		        font-size: 1.7rem;
margin-top: 20px;
			}

	@media only screen and (max-width: 600px) {	
        h2 {
            font-size: 1.2rem;
            margin-bottom: 1px;
        }
		#cuerpo {width: 95%;height: 100%;visibility: visible; display: all;  margin: 0 auto;}
		.horizontal-list li 
button { font-size: 0.9rem;}
.resultado{font-size:1rem; text-align: left;}
.aviso{font-size: 0.8rem;}
}
</style>


		

<script>



	let datos_brutos;
	
	let datos;
	
	function borrapass(){
		localStorage.setItem('password', '');
		console.log('Contraseña borrada')
	}
	
	async function decrypt(texto) {

		// Este es el texto de apoyo del programa. Está encriptado por el tipo de datos que se usan

		let cipherHex = "cc3dc6d6ac70a0726b899d7a98fa314cb073a451f0f01cf40e4d25ccae760c93ff89771118399d820209fa590ab7cf94ba3f3addfb46309be5beb5bcc3e954e921b9ce12f8b2afbbb8e5b222910ad883ad46030703ea3bd69327bf3ee86b883ef9e4b606b80b1bf0f8960adfbf95a8ac3f4c3845dc86356f9073638bb6ec1f1f853b0503fd940463f25c1a1f34689e4de952e8bc5b29a4e3d4dc07665b400d63a9311e4b3b342f4e7b6a335d137fb7b92d066e6eecadbd1c300e7a902bfb066884b988f6dc24ff8517d4d32c825665806aae64ca737b72e6b3c7ebb1ee15b976bee0267b6439a1e2e789b5d402a641b31204690c6538911af7d68622df9b10f104c0333bd167625149b8ea0ae045e9929724e13bb6cc337790b37fff7a28525881fff1c15b1917ffa97ca32f94d161d0b8dc61f579d9c213e9441bd674b468f6c5915d1e370e9b894b0d624f0f285a507501dc58e8ffa6b2140aecda7dbd0e600d07713d93b4fc078206bb64aaa339cedef9191f34b39052023a9805d8c3a1afd332ed163d0520d2fd87796c36918d7249aa73827eaae7712d7288ae7acc55316e7c1db5ffd65d770a60d797dcaabc18da41ba0019786234aaf2e42e193580b0428f9d83cb9c28bdcba1bc83887394a6feeeb1248f2d0fbb2e49f0c1ff1b4c09a8bf23a552c344f61311c9be630c6c831a9801f9c38a7f840ef1d67d4aabdeff2b093624bf2bce902fdc65b30bef090ffd5b0af75c8ffd9c807934d845551b6810ab7bfa1898f49bfb5c975ffb103f18bc5e7fca6986192a37b50f0ebabbf43511790304228aa28a27225254a10ac1c6454dc194f2d29f6b2b50e7e64efa1b948effb602637b413191906954a9763647e1c75e4df7bad1a692caa55fe38ad4f6a268b416b5856ed717859629cb95ccfcd8e32205936291a343bebf1809835f4dfdfe2ae3c3efd664640694f788ac7a23d9e72235d24b5a4eefce6aea35fa7258db9612b009ef44984e036b641d0af7c8eb2912e75b3500f9a69f544475954edee28816da2569a4265d4414df368c5e74b32c120db3faaabb26231493ca19470272be10402bc9425e770f377ab7ce5cb1cd102e0753c9a15109c2eb975c15c4612b00d9722332c1debc28a7984eba358d1b4629c84cc699e50459321e67fd2147d7bc2898a4dc73ec963263ded9ca594c595e919e04a6ba72a8801d0578926da04417b11d9b59c63cf23e019fabed07945297a6fcaaf97e0b2d6dd2754d26ea4d8d8da67574ddb322993b47b655d2e0c63139723e2800d49bb18025d8b4e8a0671ef63fc316a3049cd0af280d1d8d1fa25f6320747fdf2557b2a38318e8b6ff87a7a1c538d2122b5db91cbb8a02736af25309c4f24884a333ec986c4fcc36d4513ee293f30ce0a1d62388e03788fdd9e912d5b6dd323dfac4089415a2d6dce28f21e147d192ab2d98d4b3b0b23b8ef72a68d7b83d4f09160c92e956502bb0b5589f36bc3a3ca6ef7c5de38f2395ab79e3d1d2f253c8f8bf6c346a6671e9f247902a4d437f503a5ab901795cdc692df972acd63ca728111e5d2e06936658fc9226809a3ad9cad34c29103aaf229b880ad69040f1c0024074b6c082a1742c29f862d7b5e3a9673647c4cf6b65b1c1416494b6fe179987b74da6593111b8e227453431cd1c5cf832696e24d29da5e99ea76f85a97ebe73ffd42fe1086731f8b35f34f16a148b81d0a250eed0557563bf1d4ddc5f9f42809c39f9a7646562850c41c73b09c6e86ec5d3424fe9f71e3d65ce6675c82be7be888119d762504fa7624b1786c63b64e4e07da9094acdf4acea6e61fafd92425b893b426dfef4aa78fa73fe1ba6f8b32e8fb059d12f6377b3a3612be4f08233cdb20111f2edfe78a71231323835d714cb12d45240f3cab68568afe1dc784d03613de14aae26ce16b1d114da47eacf6bbfce709177afdc40e19e098178ed61acdb52aacb1369fa7e418503bcaaf693d42af2437377d135985b0f6884847d006930061739a919e71ddfa7211da01f569a6810793e58eabd808aaaeed39537e73c55338ad26085d8ecff5c3f7419ce12fc90a6dade99afd27f6007f574515ebbf9608b13951aeb9f4a08d9ac09e8248c204b23b5dd6ef410871aa599fec336223d1a147b570273f281ccd797eb193bd827dda39911aa4acf808f3592b513965ecf228ffd4f2ce88674c35a197b14094d9e470eaf9f2fa9218d267b8078740977586e84a3076c0f9242f2a8fabad159ef48e3c7ea1b4cfeea1d511e3259f4760ca8db7e1ed9f64a5fc17e383a8b52d94ede093f7319be1e0a7d5abc90145fac461c78f190d57acf0c13bb3bd9e2ea5efa2833002574d96409c68631c1623f445eef49701fd3c18a97dfdebc853a3229feaed8e20867bfe1c9896a7db9e1efe392f6c92aea9c6a9a0bd5ded2dcdf9b95bf562b072323bc4a5407ce0f69b1f3471b5c1c88d63bc634e0bab2b4beeb8a859b5bd048a001157e1bb527eebd271587c13929822f8f84f6ef7728da21b74463fcb3499a8d6f18f56b8c4f41d76880a96a4d5413a6a6fee4b4b2941bee877b936e21112dbaf2073be9c2564581ba5f4bbdaff99f4c3c73cb9559ff3bb90991d06008269d00a983b526b494898afa333d6b8ab664730b33ff66ee600d2773ca9f2a8c65a5cd197017a1d44bd303ce45c44c8f5e881146ff51856c8d7f589f0d0e9ca8395b791222a5cc178c6a76663bdbb550372c8db4ef32b11b57233ee860fa59c6a89bed80723ffc8c366d68bff23941fcfd9b2c6f2f1437a0b035104d43e3fc0585ebf5ebcfd12269949b02ac";
		cipherHex += "da6ee00987b98eef1ac660e91049d9132d31a24672e424f48bff09f4b5850f1ad83d31440c59b2d3903f68c3da8d7c3c704108e1b132bc6e32dda97f89519aa679b86021dd734c329c67465c78d24592d1ab3bfb7b295c59fb6f1d550ae9663f158cdac626f79ca7073c0c02fe4d6df4aba11792dccfd71fb73769044846ebd30bf80c720443199df3ba0de10f437a23a845dcd65f9f9a199ca4dbfe60eb09028420eb8392ec0f72383b4cd4fa1c02ca840cd7c4aa578199f7fc553c1ab19322bd11cafac202f5329e4b247c47855166cce1a21425909bb95a8491c8fbe1f3b237b7fd05ca8b14791d3181b15c9c5e535f5f1bf321340f4e5e250c81bf449201f74cc71ece7e61d39342a3c27c1e37a191886ea928e91dfb34a0e233bd3e907c12a9ba048369de04570f04a0cc7bec5b182e7b18ce7a23de5e33d703ea978228e930f7dacdd6f8411d626f13c079ee26fb0a784be325c248d8786ee80921eeb0720996ea0099bcbb2f1c98f55171ad14f967a438c48e10b6c230736da6486c74eca031c52a2421d8c6ddd0c332c3204abfb7522cf0503f2125f9693d06caf857403f39a94f899e1cb73497e1ea374532e1152235721369522c17b303e835c0039ec7e1794d454e2dc3c863c41c9e10171bf773eac20b49f54c5d9fee516f94ef6fab20d9db58332b787c3cd9c928a234c0fe78016e019c132e9e6145177bf6fa53b1e16c634f7307425f79fab8d0aa64229eea7d89bd999efae30e3feec81f9e42278d57194b4658fd1611f44acc835e7c52733fc43ed3d29b33816517fdb4b1b064eb28421c9afe3b95a85230afdb3c5d6373305c1774bee9b537d8bb62c00b9079ed23aee2f76cebe8d3118d913b012228460fc7fc0955cfe5007934ba3349e8b4a4198dbcd352db4944b63b69680b6d805486121f7d9a1862d67c0af00cab35d1478cf0c933f2cb5492d00a1cb40ef52da14889d5aa39683ac4394eeed4a8b1620400e86efe5d56fdc15b7d18057ed5c1ffabad0c7bc17ebe20eadaf43122ce5d8fbba35efe9e319207622a727f8f0a67ccb1bbbda87afe189ee2282b6394fbc7cc59d7f86029607acb42dc3d469b007a780535aacf21ab095b50d9465222b45f83cf1173cd0ed56107d658d3d050492d6941dfc7cd0d7c445552a4d75980766bc42cfe19e3fe92ac54b28a67aaa66a4ccb1227b18131ba93653784b27d0a29249bcfd62ba67e901feabfb03f3c6e4965c1e7bf4448425c28e64f88fd88759d5413789c147f5e1c06304ffb92c1a69731890c6c97b2669bb594ccaf796f092e217193177ff592c1d0ab1748ba780129cc905bf4cefe40a9cb9f3ffaf6b93c06a3b709f1fe8ffd75380fdb9e32f139c1b285cdd85a21f3f00d27a3f864f4334671541b2ebd9bdd77428dc8d345eef3ab96f0aecdaba125799e070a2b6c400a1e522b0dbab58d2e213a536316a2271128ae5291e72338629c6abd68f9e809abbcc71c8e819f1ab05b8c905e87baa9a9fb820330c9846c8367b8d8b818a0badcacbe408a7b6f487f830cb9cbcb80c2aa9584d98f857d31f0fb2fd55284f5d4f6f9143cc281fa0c985d9f8e2b09485e3c23a7ec63f9562fca513e7fc7ee6749ff8dece1c429957a9806402494aceb1ec72f9be405f9f3364a2d35496548e53089460f943f0ef0be490f7f72a140de24f3699707119f8705a897e368ce393acc09f1a69694d2d273121586d895e4bba10db18f3db339a8a3ce9943b89b45792c5f71936d2cbbb1a97f63b409ee99bdd5cfab2e29de93572e2ac49333701b1020eb87ae57380b4907a0b5143180934e2e3caff83c07fb1d02f7077eda8d3fcdf93ff3915683e990663d2de7e032bd6a4a01004d3847f73fb8afc4c5d6375f36f205031d4fc45e82b34816c6edaffef44e56266d2b54910a030afac8a3f2393613bb3cf5eecec6fa9af98804c6514d5df731c28607fdc18a989716b1376d2d5f6e71847c45deaeffa4159c7a032ddab599a6a5554ea404dc676821fcee98d775a353aa4e844a38baffceebf749180915c033344817370d0216c553c0258c419865e85811b07c34826944bc7cf13a37790d85a14f49aa77563ca56de94668b17db0c4290aa9150b7574b3e02d95bb24e2eb3ec337bcef00c9495b2c7522b7d0bc5ba887b3b61778849c6462cc166ebfb73e3c8a3b5beb879cb5a7dc6e9d8310f42a96af6c1daff1facca4f9174bee5af638c39f702cba8f23d2c2575208b76f12ec1744808c0836d8ec852b32a94b14aa0b8c33f6a29c8f16443234f9a72b607858c2f6d0b8e0ea2c4253e30418dd1a4ceff8a4ff0823d5321dfd960d7187d911df64dda439f728fd52b5b3302257334f82da71b3074738c22daf686b762a96adf812687bd24ede7c87b90a4775cc814ce3f6d3ccb7d87cca69d3ccabe494b701b2355159e69a719952c6c1ff4897fc37e84dfc87643dca7a736581e82ef0c89c86e710440fc09cbb8dc1fc102174fb9b042d4359194b879415d5d2383c73c8c806a82e272b7405e855aec2ba4a22d4a3733ca776fc96bc753f7427d91d1e4e0998e10bf45511e9f624f4203cf42d79190d930d5e4c581045801bf68e7ab0494fe219b77c379194e3438a1c6d79c133f01bf1239f888d894f7e10b56a3deeef9708cfacc8c8f3539cd35c9b4a25edede024fb1f60ded614a467c9551b2351aa20a31cbc9d04a31972ad94245859b578fb422896708b6d2ec3a74e96190910027f74763d477e14c2f89880f1a93644a5bab792313e141417a72a826e987e6fc68457f8d971b7f3edf0f5839801325f2938a073376d"
		cipherHex += "9e61b06c1093b434b61b5e120d91f826afd0e0a51e422aaa50caed7e3db23c89d676b8c3c337fdce04b1766e02d4c87a1094018462316840c14d05267c1cc6a7a7877544e42c09c67befd73c5aae43b213bb3f26542f70585c23b70b62f27c0e13138497d862c041f5af699bfefc53a43370ee43469921c87e5449a3daffdffeb11ecdeb3fe77d04a8658ace9c4ac176820c6fde0d14ee191bb0dd73a41b4e16d217e4dd7852bd6650b2941161b9c50ec4e7e2737e35b79dab07052f9c97c4fd63bc180dc80117f7de9f9c219f46c2876e3ae386bb52b46f3898404848cbec962d95c4914e8bc08c6038ef3ed18a60b1d44a160541009b2e875d0082c4e2abfc30e87a07728a3fd1a78be22bdf77c54a0f6c3d93f5c976bf0be701d70b64"
				// Funciones de apoyo
		function hexStringToBytes(input) {
			for (var bytes = [], c = 0; c < input.length; c += 2) {
				bytes.push(parseInt(input.substr(c, 2), 16));
			}
			return Uint8Array.from(bytes);
		}

		function removePadding(input) {
			padAmount = input[input.length-1]
			unpaddedSize = input.length - padAmount
			return input.slice(0, unpaddedSize)
		}	  

		// Código de desencriptación. ivHex y saltHex no cambian entre webs. Siempre uso la misma.
		const saltHex    = "55de388d8fd8e67b6da0e68d4022e444"
		const ivHex      = "05998ad87dde9461c89b50cc97ebbb8e"
		let salt = hexStringToBytes(saltHex)
		let iv = hexStringToBytes(ivHex)
		let password = new TextEncoder().encode(texto)
		let passwordKey = await window.crypto.subtle.importKey("raw", password,{name: "PBKDF2"},false,["deriveKey"])
		let key = await window.crypto.subtle.deriveKey({name: "PBKDF2",salt: salt,iterations: 1000000,hash: "SHA-1",},passwordKey, {name: "AES-GCM",length: 32 * 8, },false, ["decrypt"])
		let cipher = hexStringToBytes(cipherHex)
		let decryptedBuffer = await window.crypto.subtle.decrypt({name: "AES-GCM", iv: iv, },key,cipher)
		decrypted = removePadding(new Uint8Array(decryptedBuffer))
		plainText = new TextDecoder().decode(decrypted)

		
		datos_brutos = plainText;
		
	}


 function recopilaSeleccionados(){
		resultado = '';
		espacio ='';
		var elem =document.getElementsByClassName("selected");
		for (const element of elem) {

			if (resultado.length!=0) espacio =' ';
			resultado = resultado +espacio+ element.textContent;
			};
	return resultado;
}


function estaPalabra(frase, palabra){


let patron = `\\b${palabra}\\b`;
let regExp = new RegExp(patron, 'g');
let esta = regExp.test(frase)
let result = esta ? true : false;
return result
}

			function CambiarPrecio(precio) {	
				let nuevo_precio = parseInt(prompt("Introduce el precio", precio));
				if (nuevo_precio != null && !isNaN(nuevo_precio)) {
					dibujaCuota(recopilaSeleccionados(), nuevo_precio, VR);

				}
			}
	
	function devuelveValores(indices) {
	    const indiceArray = indices.split(' ');
	  let resultado = datos;

	    for (let i = 0; i < indiceArray.length; i++) {
			resultado = resultado[indiceArray[i]];
	    }
	    return resultado;

	}

function showSelectedItem(item) {
const container = document.getElementById('list-container');
		

	x = parseInt(item.parentElement.parentElement.id)+1;
	const nombres = devuelveValores(recopilaSeleccionados());
	const nombres_valores = Object.keys(nombres);
	if (nombres_valores.includes('PVP')) {
		precio = nombres['PVP'];
		VR = nombres['VR'];
 		dibujaCuota(recopilaSeleccionados(), precio, VR);
	}
	else
	{
						let txt_resultado = document.getElementById("resultado");
				txt_resultado.innerHTML = '';
container.appendChild(generateHorizontalList(nombres_valores,x));
		
	}
}

function generateHorizontalList(items,nivel) {
const list = document.createElement('ul');
list.classList.add('horizontal-list');
list.id = nivel;
items.forEach(item => {
const listItem = document.createElement('li');
const button = document.createElement('button');
button.textContent = item;
button.addEventListener('click', function() {
const selectedButton = list.querySelector('button.selected');
const nivel_actual = parseInt(this.parentElement.parentElement.id);


	for (var i = nivel_actual+1; i <10 ; i++) {
		var elem = document.getElementById(i);
		if (elem) elem.parentNode.removeChild(elem);
 }

		
		
if (selectedButton) {
selectedButton.classList.remove('selected');
}
this.classList.add('selected');
showSelectedItem(this,nivel_actual);

});
listItem.appendChild(button);
list.appendChild(listItem);
});

return list;
}

document.addEventListener('DOMContentLoaded', function() {
	
const container = document.getElementById('list-container');
const cuerpo = document.getElementById('cuerpo');
const sinpass = document.getElementById('sinpass');


cuerpo.style.display="none";
sinpass.style.display="none";
		

	//const nombres = Object.keys(datos);
	const nombres = ['PlanMy Mac','PlanMy iPhone'];
	
container.appendChild(generateHorizontalList(nombres,0));
	
});

			function dibujaCuota(modelo,precio, fv) {		
				
				
		  		if (modelo.includes('iPhone')) {
				      rate = 6.95/100/12; 
				      nper = 24;
				}
				else
				{
				rate = 7.45/100/12;
				nper = 36;
				}

				pv = -precio-18;
				pvif = Math.pow(1 + rate, nper);
				pmt = - rate * (pv * pvif + fv) / (pvif - 1);
				intereses = ((pmt*nper)+fv)-precio;
				codigo_enlace = '<a class="link_precio" title="Pulsa para modificar el precio" href="#" onclick="CambiarPrecio(' + precio+');return false;">';	  
				texto_resultado = 'Importe: '+codigo_enlace+'<b>'+precio+" €</b></a><br/>";
				texto_resultado += nper +' cuotas de <b>'+redondea(pmt)+ '€</b><br>';
				texto_resultado += 'Y una última cuota de <b>'+redondea(fv)+' €</b><br>';
				texto_resultado += 'Pagando <b>'+redondea(intereses)+ ' €</b> de intereses<br>(incluidos en la cuota)';
				let txt_resultado = document.getElementById("resultado");
				txt_resultado.innerHTML = texto_resultado;
			}
	 
			function redondea(valor){
				if (Number.EPSILON === undefined) {
					Number.EPSILON = Math.pow(2, -52); //Hay que meter esto para que funcione en IE11
				}
				return (Math.round((valor + Number.EPSILON) * 100) / 100);
			}

			if (localStorage.getItem('password')) {
				pass = localStorage.getItem('password');
			} else {
				pass = prompt("Contenido protegido. Introduce la contraseña: ");
			}
			decrypt(pass).then(function() {	 
				datos = JSON.parse(datos_brutos);
				localStorage.setItem('password', pass);
				// Hace visible el cuerpo de la web, para que se pueda usar el programa. Los datos desencriptados se guardan en la variable "datos"
				document.getElementById("cuerpo").style.display="block";
				document.getElementById('cargando').style.display="none";
				
		   	 }).catch(function (error) {
				localStorage.removeItem('password');
    				console.log("No se han podido cargar los datos. Se borra la contraseña guardada.");
					document.getElementById("sinpass").style.display="block";
					document.getElementById('cargando').style.display="none";
					
 			});
			


</script>
</head>
	<body translate="no">
		<div class='aviso' id='cargando'>Cargando...</div>
		<div class='aviso' id='sinpass'>No se han podido cargar los datos.<br><a href="#" onclick="location.reload()">Actualiza esta página</a> e introduce la contraseña correcta.</div>

		<div class="cuerpo" id="cuerpo">
			<h2>Simulador PlanMy</h2>
<div id="list-container"></div>
			<br>
			
			<div class='aviso'>	Los valores son aproximados. <br>Por favor, no imprimáis esta hoja.</div>
			<div class='aviso_mini'>14/10/23: Valores pendientes de actualizar: iPhone 14, familia completa iPhone 13</div>
			
			<div id ='resultado' class="resultado">
			</div>
</div>
</body>
</html>
