<!DOCTYPE html>
<html>
<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="UTF-8">
		<title>Simulador PlanMy</title>

		<style type="text/css" media="print">
				body {visibility: hidden; display: none;}
		</style>

<style>
    h2 {
        font-size: 1.8rem;
        margin-bottom: 0.7px;
    }
			#cuerpo {
	            line-height: 1.4;
				
				width: 60%;
				height: 100%;
				visibility: visible; 
				display: all;  
				margin: 0 auto;
		        font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
			}
			
			.aviso{
			    text-align: center;
	            font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
	            font-weight: normal;
	            font-size: 1.5rem;
				color: #616161;
			}
			.aviso_mini{
			    text-align: center;
	            font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
	            font-weight: normal;
	            font-size: 0.8rem;
				color: #919191;
			}

.horizontal-list {
display: flex;
list-style-type: none;
padding: 0;
width: 100%;
margin-bottom: -11px;

}

.link_precio:link, .link_precio:visited {
  background-color: #f2f2f2;
  color: black;
  text-decoration: none;
}

.link_precio:hover, .link_precio:active {
  background-color: gray;
  color: white;
}

.horizontal-list li {
flex-grow: 1;
}

.horizontal-list li button {
width: 100%;
background: #f2f2f2;
color: rgba(0, 0, 0, 0.6);
font-size: 1.3rem;
cursor: pointer;

padding: 7px 10px;
margin-right: -1px;
border: 1px solid rgba(0, 0, 0, 0.2);
box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);

}

.horizontal-list li:first-child button {
  border-top-left-radius: 5px;
  border-bottom-left-radius: 5px;
}

.horizontal-list li:last-child button {
  border-top-right-radius: 5px;
  border-bottom-right-radius: 5px;
}

.horizontal-list li button.selected {
background-color: #c1c1c1;
color: #000000;
box-shadow: none;

}

			.resultado{
			    text-align: center;
		        font-family: "Lucida Grande", Tahoma, Verdana, sans-serif;
		        font-weight: normal;
		        font-size: 1.7rem;
margin-top: 20px;
			}

	@media only screen and (max-width: 600px) {	
        h2 {
            font-size: 1.2rem;
            margin-bottom: 1px;
        }
		#cuerpo {width: 95%;height: 100%;visibility: visible; display: all;  margin: 0 auto;}
		.horizontal-list li 
button { font-size: 0.9rem;}
.resultado{font-size:1rem; text-align: left;}
.aviso{font-size: 0.8rem;}
}
</style>


		

<script>



	let datos_brutos;
	
	let datos;
	
	function borrapass(){
		localStorage.setItem('password', '');
		console.log('Contraseña borrada')
	}
	
	async function decrypt(texto) {

		// Este es el texto de apoyo del programa. Está encriptado por el tipo de datos que se usan
		let cipherHex = "cc3dc6d6ac70a0726b899d7a98fa314cb073807df2f151a11e4d5286ae0d1ec3eaf45c660632908a4c1d955253afe4e0d82836abac5233cce5b8b1cedbe057ef3eb0d757e1bcb5aaba92a7288e09c381b901050971f159d6936daa35e471ed0a89fcf717df6c65e4fbda14c4bffcc0cc3c564122cf8e2467d97f03ee9be20718843b7b4dfdf82d63983e7b04206b9904ac01fcab1e5b93d5d4dc48745a1a5d70ee3741247c69764e7b6a3322146bcaa02d0e207afb99cf04711b13ff57fb6a0b93ba81ebd63fe3903caad3208528318c64e43bb6071e61eec19cf0a7b761bb02d4fb25646c3ae4b1f39ece9f329d41b35d136817674c8e45b0d08850d9b95de908892826c0130a0851c4e81bf407fcdd8e30906dd3946a6fbbc77f8b103b5e5d8be8e5d621696397bc76b92694822f9ae9d202a93ac9bf0ae93d059848c002afdd92501c484281861c0d644b7d3054547c19d64db7d489bc0c0ae1cb69f41e5013077d72f686ac52db1e9010cfb031b08ae20f4640b1e43811369a1fddccf2eaca3c9829094e38deb692656835abc372428533f01281e71b421493b86baa332b7a751ea9f3b138281c75d496b5f1af5fdc4fc8063b35ba831986a9746d5dd9a842e9c88fc0d67790e0ddbcf4d22ac9bceaada64bc81731bb2e0be0cae4193c16f7f825ab20a422f6135bdbc7680274ae6aea49a7d6832a9502bdc8181ebda3e62b631b56cd47ad8221dc7fb212e17d0b8d4301f45994e096cc7934d823681f2308ea22887cfde0e6aa4c9a1cf7785c64bc3215dc6a920a4e4bae0142f3a7f856506bcda691f3849027225254c008f3c64500d7fd88a0eb033d5befee57ec1c8fd1d4990c7b1a036a82842242e53a6900e7982506dcb290bed393b620b2c687afba43c00ba59d659c018e8f3ddaa5ccfc92f6417df079d6b850b4a4161e950639ff8a40f0cde6c9666f579a83efbf725582f13676c866203cf8c561fc37af683da1e466d81ae14798540f0d02424de9d99035c21af24743c2e687151d62f42ac9a2901d983500de54292c07d033854862be344d77c3eac4ea362d4180ae326a5d64ae7706678109670717766ccacd900571383f5f03ebe6071ec2e0b81c06cc222b6af400515ea5c4b221bb9442ba358d1b4629cb4cc086ff0917634179ea5a570f478f8593f473ecdc2361d6c7af6d3c411f81fc65d8a17be7980d0867987ab61d63b369f14ecc3cea340bcef4c6289a4accdda4e7e9720d2302d203157ff20e4d5d75463995e460893810b631b5f4bb602e796b332daee9a1ee76cdb7abac0f7d8a3faf76b70c96cbbc506909ca07b35e7c270660806200b2c2e76af0f7efe0fcff8222dd452b3ad906a384486814953b5683ef5e87789f4bad511f9377c5526bf5dcea1895f6c23bc9b9458efbabf119d1b5d22529edbe78e07db2dadffe8236ad5f8edae76296cca1c28309fcef6b7bd6fe6c41113b7ce7ba03093ba4fd4bd42ed9694afeb66476978f57ffbd71e8ccd7e75dbcfccf7439687075f5b65dcf345a476c503a5ab901795cdc692dfd78a7c127a95c156e452001947c40b1d777dff57df6c39d1a700870bf2c8df513d6fa6d83b26e2160b8cc97ba0c4927e006b2a5f7a568655ad4807271a1ce0c01a6c2944e81e6d62abd4f247ed3ee2a5b2f53b10e53b42d797524d8c2e2ef90d508e5ff2cae79b6cf54aa385c31f8fb4e37eb1e41d49789b154daa24d3474d87233c9498f21e08a2fe2c4187f6acc1154db3f06fca66ecdfc023d85dc1e5704a97d61cc37f7dcf68175b4725255a66318529999057cf5a07da2421c93e2d1f36e0ce8b9ab3631d023436e80b8bf6ea307fc6fccebbb2396b14d8e551367bcac1367f1b7d533afd16774aaf6f33aab754b404c5dc219c308c72a2be28dfaca7ca386986a1215385cb517e03e8f4fc48e46f407f28e32acac1e8637b7d10cfae27d8708f56aaddd53aacb0936800e518a04ccfbfa9cd22480271663ac6e8d58586882800f186237060e38b553b642f4d9216af045408e2a0b497b14b6ae88b6ea81d8cc2fcc483d3e82d662f083e0f20b3f721dbc0af495a5cdc18a84ac7f6b62a76e451caad41af909801ee39f3444ccba509c26f84a5a28b5cb6eee4ffd6ab5f7add53a77267e3f56591a0cf491cf8282ff145fbf33a0f58b1aff5ee2abf335ebe74ec350d70fffee47259bdc78cc14460760614091470edcc423a4768d207ff2607c00754f779088796c07964d83e4e8b7d706933cfed732aafa99a15c44086b2d976219afd874778be10d08c11b5f58ee0aca41931243071fce0601785ab1901244f36d3376e9f1973685564be42d80f1f30d3a92cd6f145aab7c48d68431d779395a3bdb39685ec2a4eee9cdd6f398203951bedab0bb1003dc83c5816f36f6f4e3998f361ffd9dca2adb5ed9d29f8394d296ac337a072323bc4d6b31851767f9e74f05460db8d63b842682c2d4aff9a79293ef4705e4071a262403bd6ff5a02308cfdc295cd53bf29df6855a5aa84dd5526bf4aa5cf5f17a0ee20def4343d323ccab79311bdd04169aba87a2d703afde09f30a2c1a48e0e2046efcbe2243f1a25140b9a4fb8929137dd3953dad28ad4a85fd4b25798b10d7d0ef6aecd7c0fe926a2519dbf16879476ce277fe0e142704809f40a117bfd8197d13bac007dd71ce47c44c8a5a8e065def7aaa62950e0dc24f189fae6646696757e5d456d57009025ecfad5b7a3ae4cc883ca97c37383df6759e25d2aad5f3906e3afdb6786d6aebe558258ee5da3f084e7d3badad2172264dfb986e93fff0ec8ad33868d8d438e2";
		cipherHex += "da65ae09ed94fc8012d66aa00b5fc10d3a51d25e33f54797f5e90ab8ac9e07629849591d143addb59c316f8bc49b6a2469526c91a973aa0f53a3b874c5458aad01f81449846b2851ff6b4858359d0cc1caa549df46295c16e067004e05ef390f5a82c2fc6dbd91af49286d5de9031f9880a11b97ad9ccc09ee436b702250e1db13f55f690a5960fae0b21eed444f184d854bc4d5529de4579cc8f2fe0a896c189025e9c8d6bf147c2b593cccbb0f76c848bf66e9a51481f4e5b80d280ffbe576ab6cd3faa82f8740f2293075449f4a1ea9efba7644878fbb5fce93d8f8aaf0a534b0e978d38b7e546f43edd34f95534944277efd3951685e4a2309ccec5a8831b8d36bb9d36560988b03fad11d5864f981902ff03c8d0cc934a0ab25d951ec7c7ecdac079b6ec50830645bb6df7aed5a1a436416d63334b84f01d703a285e64795309bb0dbd5e143046e00749f3ef3308616aefe1b158f12b92779a61829baa3105ff3b2598197cf2f68f2e45c7da001f506da38a8e500b5dd313e3eef513369f8b03e884f0b32003d7acdf41ac32000adb0592df6287f554da0715c67a9f4580e7475ed1e87ea1ef96fcc95abfbf48ff53866785147a9e8d265a83ca260d5444d714b792d05566c9aba41fdae3caf684dbb68fc9b7f2a83144b90a15d0cfac261b320d7c7542e3b0c1465c1aa4ec138c9fe301c75188f773bde794b5d6f889f35eea671743a78c9e08c7baaedc0a62e2e96e52f90ae9989f6df4e4d82e31ff427479b54045a2333f30e70935dd88859315067398f3dc0b7cb29fc7c179799c3c20888384f1484ec54eba83e5abcd3235d62207c484844a02965c0faf8209913da0fbc33bba8815e9f828a09ecf0581a343e2164dcea193babe90d7179a22052e9b19e06d2fbd50da73d44f86036114ab62cf3b9105528c64975c2331fe470e1688a1429126e38bccb3ebfa27854eade4691c00ba7a5b2787838c52138b88bbee871666eff2ee65619e9a8210f6c6d6ddec2f5bea16a1b9e68ad2de9c685657d890a8fbb997baf863ade146e37626ebf0a6784aaddc5c06fb9058fe0456563f8d2c7a63db5ea742e6e31de4ccc5e22fe586c774a39cdaa0cf41f483093105c3a992f90c718039602dc2f58aa2cb2c0523f7d7a4288c7cb090e5c5d53a0c044955d15c424fa1a93b288a052edf613b4eb2210994a3ca7d845dd806d43d7a169433d09e1bdc120a50bc104fce6c43d4804596fc4fcb749194c2848f143fca99361d7473e02ee0711050605674ffd96b3be9c3683166d89ed1ceba69cc0da2d630a637e5ce9650da3df87cbbd4e3cd968035f9a834fbcdfd36b84c587679baeef7e411765aefaf998f2202d6dd4ddf24389ba949fcdd85a2192f23f27a3b274975c3a71387835b190c9603ae797c553eef6b7e6a1f1dbf2b6441d89471220235a6364205f65a9b88f233e36330449e5380a50ef18cbfb63386ad27ecb38e39510abd6ea6efcedfe0cbc5b958b24f7cec1b8f2891f31d5c920d269ca98e20cdda3dca79100f817444815e46ca3c8d69aa0c19b9cbde8966935fbb02dce51c8ebb1a1ea1c0082f396279837f8ed3a0a55495348a9f4069b4c3bc0537a2c8bf3380c8dd7b6b9e6a937c5d2103248bfac9f408676c3a40595da36412c3c3f2958e936873468f62573a3ac434d7100a142de24f06895100984ac7ba89fe466b87529c10faedae2949c9d31011cc4d68283dbc455a18375bf5cc98ec08147bd913b372c3358930749dfa0bd7865f01ce089deb1aaf33f21969f304c079b8520125a462ef3aade4430013650acb7123ff2f42c3441fceb3645f56f02f5077eda843ddae32bd8ef568bee93147138efe66dc11e544c48116b18ec29e1dba3d6de420d20e64f153035b64989b03c47ddfbf68af63a3c3767224e900752048ea8b4fe4c6004af73e0c3b4b4e9f4aa9a06845f3f5df531c28505ffd69683bc68b13c6d2d2e2264877a1aa2dafff44047cfbf4c999be9bee4454da712ab343766fae0eae875e906f51956f391a99abef3b65a6f5f499c6a25460f7e1a01609536987c946aec659c3202b97e3c9f723ecc08992a3f70119da70718a460553bd448a95e29e80fb6c25b12a218057574b3e02d95bb21e5f424c373ede113ca257e6c6d63eea2ba5dda9fb8b91778849c6462cc166bbfaa273ac53b5beb87a589bac022c21ab240299cca3444b7c4b7ee9fc85953ed14ed26d4ff656ca2846dc7bc393457a17510e00d21b4fc1077cc8afd4e24ee5606a3009856c2d284ce05235d4ae8a8607b6341d192c5f8f8e5624e348c2916c51d4b9ba3aae72553a75e7fed9c157789884ef41addf75caf69a3062a4ec86e191571fdfcabaaffd53e2c2af8bfc5c09b17af91d7"

				// Funciones de apoyo
		function hexStringToBytes(input) {
			for (var bytes = [], c = 0; c < input.length; c += 2) {
				bytes.push(parseInt(input.substr(c, 2), 16));
			}
			return Uint8Array.from(bytes);
		}

		function removePadding(input) {
			padAmount = input[input.length-1]
			unpaddedSize = input.length - padAmount
			return input.slice(0, unpaddedSize)
		}	  

		// Código de desencriptación. ivHex y saltHex no cambian entre webs. Siempre uso la misma.
		const saltHex    = "55de388d8fd8e67b6da0e68d4022e444"
		const ivHex      = "05998ad87dde9461c89b50cc97ebbb8e"
		let salt = hexStringToBytes(saltHex)
		let iv = hexStringToBytes(ivHex)
		let password = new TextEncoder().encode(texto)
		let passwordKey = await window.crypto.subtle.importKey("raw", password,{name: "PBKDF2"},false,["deriveKey"])
		let key = await window.crypto.subtle.deriveKey({name: "PBKDF2",salt: salt,iterations: 1000000,hash: "SHA-1",},passwordKey, {name: "AES-GCM",length: 32 * 8, },false, ["decrypt"])
		let cipher = hexStringToBytes(cipherHex)
		let decryptedBuffer = await window.crypto.subtle.decrypt({name: "AES-GCM", iv: iv, },key,cipher)
		decrypted = removePadding(new Uint8Array(decryptedBuffer))
		plainText = new TextDecoder().decode(decrypted)

		
		datos_brutos = plainText;
		
	}


 function recopilaSeleccionados(){
		resultado = '';
		espacio ='';
		var elem =document.getElementsByClassName("selected");
		for (const element of elem) {

			if (resultado.length!=0) espacio =' ';
			resultado = resultado +espacio+ element.textContent;
			};
	return resultado;
}


function estaPalabra(frase, palabra){


let patron = `\\b${palabra}\\b`;
let regExp = new RegExp(patron, 'g');
let esta = regExp.test(frase)
let result = esta ? true : false;
return result
}

			function CambiarPrecio(precio) {	
				let nuevo_precio = parseInt(prompt("Introduce el precio", precio));
				if (nuevo_precio != null && !isNaN(nuevo_precio)) {
					dibujaCuota(recopilaSeleccionados(), nuevo_precio, VR);

				}
			}
	
	function devuelveValores(indices) {
	    const indiceArray = indices.split(' ');
	  let resultado = datos;

	    for (let i = 0; i < indiceArray.length; i++) {
			resultado = resultado[indiceArray[i]];
	    }
	    return resultado;

	}

function showSelectedItem(item) {
const container = document.getElementById('list-container');
		

	x = parseInt(item.parentElement.parentElement.id)+1;
	const nombres = devuelveValores(recopilaSeleccionados());
	const nombres_valores = Object.keys(nombres);
	if (nombres_valores.includes('PVP')) {
		precio = nombres['PVP'];
		VR = nombres['VR'];
 		dibujaCuota(recopilaSeleccionados(), precio, VR);
	}
	else
	{
						let txt_resultado = document.getElementById("resultado");
				txt_resultado.innerHTML = '';
container.appendChild(generateHorizontalList(nombres_valores,x));
		
	}
}

function generateHorizontalList(items,nivel) {
const list = document.createElement('ul');
list.classList.add('horizontal-list');
list.id = nivel;
items.forEach(item => {
const listItem = document.createElement('li');
const button = document.createElement('button');
button.textContent = item;
button.addEventListener('click', function() {
const selectedButton = list.querySelector('button.selected');
const nivel_actual = parseInt(this.parentElement.parentElement.id);


	for (var i = nivel_actual+1; i <10 ; i++) {
		var elem = document.getElementById(i);
		if (elem) elem.parentNode.removeChild(elem);
 }

		
		
if (selectedButton) {
selectedButton.classList.remove('selected');
}
this.classList.add('selected');
showSelectedItem(this,nivel_actual);

});
listItem.appendChild(button);
list.appendChild(listItem);
});

return list;
}

document.addEventListener('DOMContentLoaded', function() {
	
const container = document.getElementById('list-container');
const cuerpo = document.getElementById('cuerpo');
const sinpass = document.getElementById('sinpass');


cuerpo.style.display="none";
sinpass.style.display="none";
		

	//const nombres = Object.keys(datos);
	const nombres = ['PlanMy Mac','PlanMy iPhone'];
	
container.appendChild(generateHorizontalList(nombres,0));
	
});

			function dibujaCuota(modelo,precio, fv) {		
				
				
		  		if (modelo.includes('iPhone')) {
				      rate = 6.95/100/12; 
				      nper = 24;
				}
				else
				{
				rate = 7.45/100/12;
				nper = 36;
				}

				pv = -precio-18;
				pvif = Math.pow(1 + rate, nper);
				pmt = - rate * (pv * pvif + fv) / (pvif - 1);
				intereses = ((pmt*nper)+fv)-precio;
				codigo_enlace = '<a class="link_precio" title="Pulsa para modificar el precio" href="#" onclick="CambiarPrecio(' + precio+');return false;">';	  
				texto_resultado = 'Importe: '+codigo_enlace+'<b>'+precio+" €</b></a><br/>";
				texto_resultado += nper +' cuotas de <b>'+redondea(pmt)+ '€</b><br>';
				texto_resultado += 'Y una última cuota de <b>'+redondea(fv)+' €</b><br>';
				texto_resultado += 'Pagando <b>'+redondea(intereses)+ ' €</b> de intereses<br>(incluidos en la cuota)';
				let txt_resultado = document.getElementById("resultado");
				txt_resultado.innerHTML = texto_resultado;
			}
	 
			function redondea(valor){
				if (Number.EPSILON === undefined) {
					Number.EPSILON = Math.pow(2, -52); //Hay que meter esto para que funcione en IE11
				}
				return (Math.round((valor + Number.EPSILON) * 100) / 100);
			}

			if (localStorage.getItem('password')) {
				pass = localStorage.getItem('password');
			} else {
				pass = prompt("Contenido protegido. Introduce la contraseña: ");
			}
			decrypt(pass).then(function() {	 
				datos = JSON.parse(datos_brutos);
				localStorage.setItem('password', pass);
				// Hace visible el cuerpo de la web, para que se pueda usar el programa. Los datos desencriptados se guardan en la variable "datos"
				document.getElementById("cuerpo").style.display="block";
				document.getElementById('cargando').style.display="none";
				
		   	 }).catch(function (error) {
				localStorage.removeItem('password');
    				console.log("No se han podido cargar los datos. Se borra la contraseña guardada.");
					document.getElementById("sinpass").style.display="block";
					document.getElementById('cargando').style.display="none";
					
 			});
			


</script>
</head>
	<body translate="no">
		<div class='aviso' id='cargando'>Cargando...</div>
		<div class='aviso' id='sinpass'>No se han podido cargar los datos.<br><a href="#" onclick="location.reload()">Actualiza esta página</a> e introduce la contraseña correcta.</div>

		<div class="cuerpo" id="cuerpo">
			<h2>Simulador PlanMy</h2>
<div id="list-container"></div>
			<br>
			
			<div class='aviso'><b>Los valores son aproximados.</b> <br>Por favor, no imprimáis esta hoja.</div>
			<div class='aviso_mini'>26/10/23: Valores actualizados</div>
			
			<div id ='resultado' class="resultado">
			</div>
</div>
</body>
</html>
